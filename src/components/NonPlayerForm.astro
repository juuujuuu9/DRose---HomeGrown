---
// Non-player RSVP form component
---

<div class="bg-white p-8 rounded-lg shadow-lg">
  <form id="non-player-form" class="space-y-10">
    <div>
      <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
        Name (First and Last) *
      </label>
      <input 
        type="text" 
        id="name" 
        name="name" 
        required 
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="Enter your full name"
      />
    </div>
    
    <div>
      <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
        Email *
      </label>
      <input 
        type="email" 
        id="email" 
        name="email" 
        required 
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="Enter your email"
      />
    </div>
    
    <div>
      <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
        Phone Number *
      </label>
      <input 
        type="tel" 
        id="phone" 
        name="phone" 
        required 
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="Enter your phone number"
      />
    </div>
    
    <div>
      <label for="ticket_count" class="block text-sm font-medium text-gray-700 mb-2">
        How many tickets? *
      </label>
      <select 
        id="ticket_count" 
        name="ticket_count" 
        required 
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      >
        <option value="">Select number of tickets</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
    </div>

    <!-- Dynamic fields for additional ticket names -->
    <div id="additional-tickets-container" class="hidden space-y-6"></div>

    <!-- Disclaimer -->
    <div class="mt-8 p-4 bg-gray-50 border border-gray-300 rounded-lg">
      <p class="text-sm text-gray-700">
        <strong>Please note:</strong> This does not guarantee entry. Names will be confirmed and tickets will be issued the week prior to the event, with final tickets sent the day before or day of the event.
      </p>
    </div>

    <!-- RSVP Button / Inline Confirmation Area -->
    <div id="rsvp-action" class="text-center pt-10" aria-live="polite">
      <button
        id="rsvp-button"
        type="submit"
        class="bg-[#D7000F] text-white px-12 py-6 rounded-lg text-[24px] font-semibold uppercase hover:bg-[#b8323d] transition-colors"
      >
        RSVP HERE
      </button>
    </div>

    <!-- Inline error box (hidden by default) -->
    <div
      id="rsvp-error"
      class="hidden mt-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg text-[18px] text-center"
      aria-live="polite"
    ></div>
  </form>
</div>

<script>
  const ticketCountSelect = document.getElementById('ticket_count') as HTMLSelectElement;
  const additionalTicketsContainer = document.getElementById('additional-tickets-container') as HTMLDivElement;

  // Handle ticket count change
  ticketCountSelect?.addEventListener('change', (e) => {
    const count = parseInt((e.target as HTMLSelectElement).value) || 0;
    const container = additionalTicketsContainer;
    
    if (!container) return;
    
    // Clear previous fields
    container.innerHTML = '';
    
    if (count > 1) {
      container.classList.remove('hidden');
      
      // Create fields for additional tickets (count - 1 because first ticket is the main person)
      for (let i = 2; i <= count; i++) {
        const ticketGroup = document.createElement('div');
        ticketGroup.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50 space-y-4';
        ticketGroup.innerHTML = `
          <h3 class="text-lg font-semibold text-gray-700 mb-4">Additional Ticket ${i - 1}</h3>
          <div>
            <label for="ticket_${i}_name" class="block text-sm font-medium text-gray-700 mb-2">
              Name (First and Last) *
            </label>
            <input 
              type="text" 
              id="ticket_${i}_name" 
              name="ticket_${i}_name" 
              required 
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Enter full name"
            />
          </div>
          <div>
            <label for="ticket_${i}_email" class="block text-sm font-medium text-gray-700 mb-2">
              Email *
            </label>
            <input 
              type="email" 
              id="ticket_${i}_email" 
              name="ticket_${i}_email" 
              required 
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Enter email"
            />
          </div>
          <div>
            <label for="ticket_${i}_phone" class="block text-sm font-medium text-gray-700 mb-2">
              Phone Number *
            </label>
            <input 
              type="tel" 
              id="ticket_${i}_phone" 
              name="ticket_${i}_phone" 
              required 
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Enter phone number"
            />
          </div>
        `;
        container.appendChild(ticketGroup);
      }
      
      // Scroll to additional tickets container for better UX
      container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
      container.classList.add('hidden');
    }
  });

  // Form submission handler
  document.getElementById('non-player-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Collect additional ticket information
    const ticketCount = parseInt(data.ticket_count as string);
    const additionalTickets: Array<{ name: string; email: string; phone: string }> = [];
    
    if (ticketCount > 1) {
      for (let i = 2; i <= ticketCount; i++) {
        const ticketName = data[`ticket_${i}_name`] as string;
        const ticketEmail = data[`ticket_${i}_email`] as string;
        const ticketPhone = data[`ticket_${i}_phone`] as string;
        if (ticketName && ticketEmail && ticketPhone) {
          additionalTickets.push({
            name: ticketName,
            email: ticketEmail,
            phone: ticketPhone
          });
        }
      }
    }

    const payload = {
      name: data.name,
      email: data.email,
      phone: data.phone,
      ticket_count: ticketCount,
      additional_tickets: additionalTickets
    };

    const actionContainer = document.getElementById('rsvp-action');
    const errorContainer = document.getElementById('rsvp-error');
    const rsvpButton = document.getElementById('rsvp-button');

    // Clear previous error
    if (errorContainer) {
      errorContainer.textContent = '';
      errorContainer.classList.add('hidden');
    }

    // Loading state
    let originalButtonHTML = null;
    if (rsvpButton) {
      originalButtonHTML = rsvpButton.innerHTML;
      rsvpButton.disabled = true;
      rsvpButton.classList.add('opacity-60', 'cursor-not-allowed');
      rsvpButton.setAttribute('aria-busy', 'true');
      rsvpButton.innerHTML = `
        <span class="inline-flex items-center gap-3">
          <svg class="animate-spin h-6 w-6 text-white" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          Submitting...
        </span>
      `;
    }

    try {
      const response = await fetch('/api/non-player-signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        if (actionContainer) {
          actionContainer.setAttribute('aria-live', 'polite');
          actionContainer.innerHTML = `
            <div class="inline-block mt-2 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg text-[20px] font-semibold">
              ðŸŽ‰ RSVP submitted! We'll be in touch soon with ticket confirmation.
            </div>
          `;
        }
        form.reset();
        if (additionalTicketsContainer) {
          additionalTicketsContainer.classList.add('hidden');
          additionalTicketsContainer.innerHTML = '';
        }
      } else {
        const errorData = await response.json().catch(() => ({}));
        console.error('Server error:', errorData);
        if (errorContainer) {
          errorContainer.textContent = 'Something went wrong. Please try again.';
          errorContainer.classList.remove('hidden');
        }
        if (rsvpButton && originalButtonHTML !== null) {
          rsvpButton.disabled = false;
          rsvpButton.classList.remove('opacity-60', 'cursor-not-allowed');
          rsvpButton.removeAttribute('aria-busy');
          rsvpButton.innerHTML = originalButtonHTML;
        }
      }
    } catch (error) {
      console.error('Form submission error:', error);
      if (errorContainer) {
        errorContainer.textContent = 'Something went wrong. Please try again.';
        errorContainer.classList.remove('hidden');
      }
      if (rsvpButton && originalButtonHTML !== null) {
        rsvpButton.disabled = false;
        rsvpButton.classList.remove('opacity-60', 'cursor-not-allowed');
        rsvpButton.removeAttribute('aria-busy');
        rsvpButton.innerHTML = originalButtonHTML;
      }
    }
  });
</script>

