---
// Non-player RSVP form component
---

<form id="non-player-form" class="w-full">
  <!-- Main Contact Section -->
  <div class="flex flex-col gap-[8px] items-start w-full">
    <p class="font-roboto-condensed font-bold leading-normal relative shrink-0 text-[12px] text-white uppercase w-full whitespace-pre-wrap">
      Main Contact
    </p>
    
    <!-- Name Full Width -->
    <div class="bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center overflow-clip px-4 md:px-[16px] py-3 md:py-[12px] rounded-[4px] w-full">
      <input
        type="text"
        id="name"
        name="name"
        required
        class="w-full bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-white placeholder:text-[rgba(255,255,255,0.5)]"
        placeholder="Name (First and Last)"
      />
    </div>
    
    <!-- Email Full Width -->
    <div class="bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center overflow-clip px-4 md:px-[16px] py-3 md:py-[12px] rounded-[4px] w-full">
      <input
        type="email"
        id="email"
        name="email"
        required
        class="w-full bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-white placeholder:text-[rgba(255,255,255,0.5)]"
        placeholder="Email"
      />
    </div>
    
    <!-- Phone Number Full Width -->
    <div class="bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center overflow-clip px-4 md:px-[16px] py-3 md:py-[12px] rounded-[4px] w-full">
      <input
        type="tel"
        id="phone"
        name="phone"
        required
        class="w-full bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-white placeholder:text-[rgba(255,255,255,0.5)]"
        placeholder="Phone Number"
      />
    </div>
  </div>

  <!-- Divider -->
  <div class="bg-[rgba(255,255,255,0.5)] h-px shrink-0 w-full my-3"></div>

  <!-- Ticket Selection Section -->
  <div class="flex flex-col gap-[8px] items-start w-full">
    <p class="font-roboto-condensed font-bold leading-normal relative shrink-0 text-[12px] text-white uppercase w-full whitespace-pre-wrap">
      Ticket Selection
    </p>
    
    <!-- Ticket Count Dropdown -->
    <div class="bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex items-start justify-between overflow-clip px-4 md:px-[16px] py-3 md:py-[12px] rounded-[4px] w-full">
      <select
        id="ticket_count"
        name="ticket_count"
        required
        class="flex-1 min-h-0 bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-[rgba(255,255,255,0.5)] appearance-none cursor-pointer"
      >
        <option value="" class="bg-[#212121] text-[rgba(255,255,255,0.5)]">How many tickets?</option>
        <option value="1" class="bg-[#212121] text-white">1</option>
        <option value="2" class="bg-[#212121] text-white">2</option>
        <option value="3" class="bg-[#212121] text-white">3</option>
        <option value="4" class="bg-[#212121] text-white">4</option>
        <option value="5" class="bg-[#212121] text-white">5</option>
      </select>
      <svg class="w-4 h-4 text-white shrink-0 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    </div>
  </div>

  <!-- Divider before additional tickets (hidden by default) -->
  <div id="additional-tickets-divider" class="hidden bg-[rgba(255,255,255,0.5)] h-px shrink-0 w-full my-3"></div>

  <!-- Dynamic fields for additional ticket names -->
  <div id="additional-tickets-container" class="hidden flex-col gap-6 w-full"></div>

  <!-- Divider -->
  <div class="bg-[rgba(255,255,255,0.5)] h-px shrink-0 w-full my-3"></div>

  <!-- Disclaimer -->
  <div class="mt-3 p-4 bg-[#212121] border border-[rgba(255,255,255,0.5)] rounded-[4px]">
    <p class="text-[12px] text-[rgba(255,255,255,0.7)] font-roboto-condensed">
      <strong class="text-white">Please note:</strong> This does not guarantee entry. Names will be confirmed and tickets will be issued the week prior to the event, with final tickets sent the day before or day of the event.
    </p>
  </div>

  <!-- Inline error box (hidden by default) -->
  <div
    id="rsvp-error"
    class="hidden mt-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg text-[18px] text-center"
    aria-live="polite"
  ></div>
</form>

<script>
  const ticketCountSelect = document.getElementById('ticket_count') as HTMLSelectElement;
  const additionalTicketsContainer = document.getElementById('additional-tickets-container') as HTMLDivElement;

  // Handle ticket count change
  ticketCountSelect?.addEventListener('change', (e) => {
    const count = parseInt((e.target as HTMLSelectElement).value) || 0;
    const container = additionalTicketsContainer;
    
    if (!container) return;
    
    // Clear previous fields
    container.innerHTML = '';
    
    if (count > 1) {
      container.classList.remove('hidden');
      container.classList.add('flex', 'flex-col');
      const divider = document.getElementById('additional-tickets-divider');
      if (divider) {
        divider.classList.remove('hidden');
      }
      
      // Create fields for additional tickets (count - 1 because first ticket is the main person)
      for (let i = 2; i <= count; i++) {
        const ticketGroup = document.createElement('div');
        ticketGroup.className = 'flex flex-col gap-[8px] items-start w-full';
        ticketGroup.innerHTML = `
          <p class="font-roboto-condensed font-bold leading-normal relative shrink-0 text-[12px] text-white uppercase w-full pt-6">
            Additional Ticket ${i - 1}
          </p>
          <div class="bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center overflow-clip px-4 md:px-[16px] py-3 md:py-[12px] rounded-[4px] w-full">
            <input 
              type="text" 
              id="ticket_${i}_name" 
              name="ticket_${i}_name" 
              required 
              class="w-full bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-white placeholder:text-[rgba(255,255,255,0.5)]"
              placeholder="Name (First and Last)"
            />
          </div>
          <div class="bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center overflow-clip px-4 md:px-[16px] py-3 md:py-[12px] rounded-[4px] w-full">
            <input 
              type="email" 
              id="ticket_${i}_email" 
              name="ticket_${i}_email" 
              required 
              class="w-full bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-white placeholder:text-[rgba(255,255,255,0.5)]"
              placeholder="Email"
            />
          </div>
          <div class="bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center overflow-clip px-4 md:px-[16px] py-3 md:py-[12px] rounded-[4px] w-full">
            <input 
              type="tel" 
              id="ticket_${i}_phone" 
              name="ticket_${i}_phone" 
              required 
              class="w-full bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-white placeholder:text-[rgba(255,255,255,0.5)]"
              placeholder="Phone Number"
            />
          </div>
        `;
        container.appendChild(ticketGroup);
      }
      
      // Scroll to additional tickets container for better UX
      container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
      container.classList.add('hidden');
      container.classList.remove('flex', 'flex-col');
      const divider = document.getElementById('additional-tickets-divider');
      if (divider) {
        divider.classList.add('hidden');
      }
    }
  });

  // Form submission handler
  document.getElementById('non-player-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Collect additional ticket information
    const ticketCount = parseInt(data.ticket_count as string);
    const additionalTickets: Array<{ name: string; email: string; phone: string }> = [];
    
    if (ticketCount > 1) {
      for (let i = 2; i <= ticketCount; i++) {
        const ticketName = data[`ticket_${i}_name`] as string;
        const ticketEmail = data[`ticket_${i}_email`] as string;
        const ticketPhone = data[`ticket_${i}_phone`] as string;
        if (ticketName && ticketEmail && ticketPhone) {
          additionalTickets.push({
            name: ticketName,
            email: ticketEmail,
            phone: ticketPhone
          });
        }
      }
    }

    const payload = {
      name: data.name,
      email: data.email,
      phone: data.phone,
      ticket_count: ticketCount,
      additional_tickets: additionalTickets
    };

    const errorContainer = document.getElementById('rsvp-error');
    const submitButtonWrapper = document.getElementById('submit-button-wrapper') as HTMLButtonElement;
    const submitButton = submitButtonWrapper?.querySelector('span') as HTMLSpanElement;

    // Clear previous error
    if (errorContainer) {
      errorContainer.textContent = '';
      errorContainer.classList.add('hidden');
    }

    // Loading state
    let originalButtonHTML = null;
    if (submitButton) {
      originalButtonHTML = submitButton.innerHTML;
      submitButton.innerHTML = 'SUBMITTING...';
      if (submitButtonWrapper) {
        submitButtonWrapper.style.opacity = '0.6';
        submitButtonWrapper.style.cursor = 'not-allowed';
        submitButtonWrapper.setAttribute('aria-busy', 'true');
      }
    }

    try {
      const response = await fetch('/api/non-player-signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        // Success - the button wrapper will be replaced by success message
        if (submitButtonWrapper) {
          submitButtonWrapper.setAttribute('aria-live', 'polite');
          submitButtonWrapper.innerHTML = `
            <span class="font-prohibition leading-normal not-italic relative shrink-0 text-[20px] text-center text-white tracking-[4px] uppercase w-full whitespace-pre-wrap">
              SUBMITTED!
            </span>
          `;
        }
        form.reset();
        if (additionalTicketsContainer) {
          additionalTicketsContainer.classList.add('hidden');
          additionalTicketsContainer.classList.remove('flex', 'flex-col');
          additionalTicketsContainer.innerHTML = '';
        }
        const divider = document.getElementById('additional-tickets-divider');
        if (divider) {
          divider.classList.add('hidden');
        }
      } else {
        const errorData = await response.json().catch(() => ({}));
        console.error('Server error:', errorData);
        if (errorContainer) {
          errorContainer.textContent = 'Something went wrong. Please try again.';
          errorContainer.classList.remove('hidden');
        }
        if (submitButton && originalButtonHTML !== null) {
          submitButton.innerHTML = originalButtonHTML;
          if (submitButtonWrapper) {
            submitButtonWrapper.style.opacity = '1';
            submitButtonWrapper.style.cursor = 'pointer';
            submitButtonWrapper.removeAttribute('aria-busy');
          }
        }
      }
    } catch (error) {
      console.error('Form submission error:', error);
      if (errorContainer) {
        errorContainer.textContent = 'Something went wrong. Please try again.';
        errorContainer.classList.remove('hidden');
      }
      if (submitButton && originalButtonHTML !== null) {
        submitButton.innerHTML = originalButtonHTML;
        if (submitButtonWrapper) {
          submitButtonWrapper.style.opacity = '1';
          submitButtonWrapper.style.cursor = 'pointer';
          submitButtonWrapper.removeAttribute('aria-busy');
        }
      }
    }
  });
</script>

