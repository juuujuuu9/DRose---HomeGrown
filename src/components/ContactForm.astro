---
// Registration form component
const shoeSizes = Array.from({ length: 13 }, (_, i) => (i + 5).toString());
---

<div class="bg-white p-8 rounded-lg shadow-lg">
  <form id="registration-form" class="space-y-10">
    <div>
      <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
        Name (First and Last) *
      </label>
      <input 
        type="text" 
        id="name" 
        name="name" 
        required 
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="Enter your full name"
      />
    </div>
    
    <div>
      <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
        Phone Number *
      </label>
      <input 
        type="tel" 
        id="phone" 
        name="phone" 
        required 
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="Enter your phone number"
      />
    </div>
    
    <div>
      <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
        Email *
      </label>
      <input 
        type="email" 
        id="email" 
        name="email" 
        required 
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="Enter your email"
      />
    </div>
    
    <div>
      <label for="address" class="block text-sm font-medium text-gray-700 mb-2">
        Address *
      </label>
      <textarea 
        id="address" 
        name="address" 
        rows="3"
        required
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="Enter your address"
      ></textarea>
    </div>
    
    <div>
      <label for="alternative_contact_name" class="block text-sm font-medium text-gray-700 mb-2">
        Alternative Contact Full Name *
      </label>
      <input 
        type="text" 
        id="alternative_contact_name" 
        name="alternative_contact_name" 
        required 
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="Enter alternative contact full name"
      />
    </div>
    
    <div>
      <label for="alternative_contact_phone" class="block text-sm font-medium text-gray-700 mb-2">
        Alternative Contact Phone Number *
      </label>
      <input 
        type="tel" 
        id="alternative_contact_phone" 
        name="alternative_contact_phone" 
        required 
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="Enter alternative contact phone number"
      />
    </div>
    
    <div>
      <label for="alternative_contact_email" class="block text-sm font-medium text-gray-700 mb-2">
        Alternative Contact Email *
      </label>
      <input 
        type="email" 
        id="alternative_contact_email" 
        name="alternative_contact_email" 
        required 
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="Enter alternative contact email"
      />
    </div>
    
    <!-- Size Selection Fields -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Top Size -->
      <div>
        <label for="top_size" class="hidden md:block text-sm font-medium text-gray-700 mb-2">
          Top Size (XS-XXL) *
        </label>
        <!-- Desktop Dropdown -->
        <select 
          id="top_size" 
          name="top_size" 
          required 
          class="hidden md:block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
          <option value="">Select size</option>
          <option value="XS">XS</option>
          <option value="S">S</option>
          <option value="M">M</option>
          <option value="L">L</option>
          <option value="XL">XL</option>
          <option value="XXL">XXL</option>
        </select>
        <!-- Mobile Button Selector -->
        <div class="md:hidden bg-gray-900/80 backdrop-blur-sm p-4 rounded-lg">
          <label class="block text-white uppercase text-sm font-medium mb-3">TOP SIZE</label>
          <div class="grid grid-cols-6 gap-2">
            {['XS', 'S', 'M', 'L', 'XL', 'XXL'].map(size => (
              <button
                type="button"
                data-size-field="top_size"
                data-size-value={size}
                class="size-button px-3 py-2 text-sm font-medium rounded border border-gray-500 bg-gray-800 text-white hover:bg-gray-700 transition-colors"
                data-selected="false"
              >
                {size}
              </button>
            ))}
          </div>
        </div>
      </div>
      
      <!-- Bottom Size -->
      <div>
        <label for="bottom_size" class="hidden md:block text-sm font-medium text-gray-700 mb-2">
          Bottom Size (XS-XXL) *
        </label>
        <!-- Desktop Dropdown -->
        <select 
          id="bottom_size" 
          name="bottom_size" 
          required 
          class="hidden md:block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
          <option value="">Select size</option>
          <option value="XS">XS</option>
          <option value="S">S</option>
          <option value="M">M</option>
          <option value="L">L</option>
          <option value="XL">XL</option>
          <option value="XXL">XXL</option>
        </select>
        <!-- Mobile Button Selector -->
        <div class="md:hidden bg-gray-900/80 backdrop-blur-sm p-4 rounded-lg">
          <label class="block text-white uppercase text-sm font-medium mb-3">BOTTOM SIZE</label>
          <div class="grid grid-cols-6 gap-2">
            {['XS', 'S', 'M', 'L', 'XL', 'XXL'].map(size => (
              <button
                type="button"
                data-size-field="bottom_size"
                data-size-value={size}
                class="size-button px-3 py-2 text-sm font-medium rounded border border-gray-500 bg-gray-800 text-white hover:bg-gray-700 transition-colors"
                data-selected="false"
              >
                {size}
              </button>
            ))}
          </div>
        </div>
      </div>
      
      <!-- Jacket/Hoodie Size -->
      <div>
        <label for="jacket_size" class="hidden md:block text-sm font-medium text-gray-700 mb-2">
          Jacket/Hoodie Size (XS-XXL) *
        </label>
        <!-- Desktop Dropdown -->
        <select 
          id="jacket_size" 
          name="jacket_size" 
          required 
          class="hidden md:block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
          <option value="">Select size</option>
          <option value="XS">XS</option>
          <option value="S">S</option>
          <option value="M">M</option>
          <option value="L">L</option>
          <option value="XL">XL</option>
          <option value="XXL">XXL</option>
        </select>
        <!-- Mobile Button Selector -->
        <div class="md:hidden bg-gray-900/80 backdrop-blur-sm p-4 rounded-lg">
          <label class="block text-white uppercase text-sm font-medium mb-3">JACKET/HOODIE SIZE</label>
          <div class="grid grid-cols-6 gap-2">
            {['XS', 'S', 'M', 'L', 'XL', 'XXL'].map(size => (
              <button
                type="button"
                data-size-field="jacket_size"
                data-size-value={size}
                class="size-button px-3 py-2 text-sm font-medium rounded border border-gray-500 bg-gray-800 text-white hover:bg-gray-700 transition-colors"
                data-selected="false"
              >
                {size}
              </button>
            ))}
          </div>
        </div>
      </div>
      
      <!-- Tight Size -->
      <div>
        <label for="tight_size" class="hidden md:block text-sm font-medium text-gray-700 mb-2">
          Tight Size (XS-XXL) *
        </label>
        <!-- Desktop Dropdown -->
        <select 
          id="tight_size" 
          name="tight_size" 
          required 
          class="hidden md:block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
          <option value="">Select size</option>
          <option value="XS">XS</option>
          <option value="S">S</option>
          <option value="M">M</option>
          <option value="L">L</option>
          <option value="XL">XL</option>
          <option value="XXL">XXL</option>
        </select>
        <!-- Mobile Button Selector -->
        <div class="md:hidden bg-gray-900/80 backdrop-blur-sm p-4 rounded-lg">
          <label class="block text-white uppercase text-sm font-medium mb-3">TIGHT SIZE</label>
          <div class="grid grid-cols-6 gap-2">
            {['XS', 'S', 'M', 'L', 'XL', 'XXL'].map(size => (
              <button
                type="button"
                data-size-field="tight_size"
                data-size-value={size}
                class="size-button px-3 py-2 text-sm font-medium rounded border border-gray-500 bg-gray-800 text-white hover:bg-gray-700 transition-colors"
                data-selected="false"
              >
                {size}
              </button>
            ))}
          </div>
        </div>
      </div>
    </div>
    
    <!-- Shoe Size -->
    <div>
      <label for="shoe_size" class="hidden md:block text-sm font-medium text-gray-700 mb-2">
        Shoe Size (5-17) *
      </label>
      <!-- Desktop Dropdown -->
      <select 
        id="shoe_size" 
        name="shoe_size" 
        required 
        class="hidden md:block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      >
        <option value="">Select size</option>
        {shoeSizes.map(size => (
          <option value={size}>{size}</option>
        ))}
      </select>
      <!-- Mobile Button Selector -->
      <div class="md:hidden bg-gray-900/80 backdrop-blur-sm p-4 rounded-lg">
        <label class="block text-white uppercase text-sm font-medium mb-3">SHOE SIZE</label>
        <div class="grid grid-cols-[repeat(7,minmax(0,1fr))] gap-2">
          {shoeSizes.slice(0, 7).map(size => (
            <button
              type="button"
              data-size-field="shoe_size"
              data-size-value={size}
              class="size-button px-2 py-2 text-sm font-medium rounded border border-gray-500 bg-gray-800 text-white hover:bg-gray-700 transition-colors"
              data-selected="false"
            >
              {size}
            </button>
          ))}
        </div>
        <div class="grid grid-cols-4 gap-2 mt-2">
          {shoeSizes.slice(7).map(size => (
            <button
              type="button"
              data-size-field="shoe_size"
              data-size-value={size}
              class="size-button px-3 py-2 text-sm font-medium rounded border border-gray-500 bg-gray-800 text-white hover:bg-gray-700 transition-colors"
              data-selected="false"
            >
              {size}
            </button>
          ))}
        </div>
      </div>
    </div>

    <!-- Submit Button / Inline Confirmation Area -->
    <div id="registration-action" class="text-center pt-10" aria-live="polite">
      <button
        id="register-button"
        type="submit"
        class="bg-[#D7000F] text-white px-12 py-6 rounded-lg text-[24px] font-semibold uppercase hover:bg-[#b8323d] transition-colors"
      >
        Register Now
      </button>
    </div>

    <!-- Inline error box (hidden by default) -->
    <div
      id="registration-error"
      class="hidden mt-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg text-[18px] text-center"
      aria-live="polite"
    ></div>
  </form>
</div>

<script>
  // Mobile size button handler
  document.querySelectorAll('.size-button').forEach(button => {
    button.addEventListener('click', function() {
      const fieldName = this.getAttribute('data-size-field');
      const sizeValue = this.getAttribute('data-size-value');
      const selectElement = document.getElementById(fieldName) as HTMLSelectElement;
      
      if (!selectElement) return;
      
      // Update select value
      selectElement.value = sizeValue;
      
      // Update all buttons in this group
      const allButtons = document.querySelectorAll(`[data-size-field="${fieldName}"]`);
      allButtons.forEach(btn => {
        const isSelected = btn === this;
        btn.setAttribute('data-selected', isSelected.toString());
        
        if (isSelected) {
          // Selected: white background, dark text
          btn.classList.remove('bg-gray-800', 'text-white', 'border-gray-500');
          btn.classList.add('bg-white', 'text-gray-900', 'border-white');
        } else {
          // Unselected: dark background, white text
          btn.classList.remove('bg-white', 'text-gray-900', 'border-white');
          btn.classList.add('bg-gray-800', 'text-white', 'border-gray-500');
        }
      });
    });
  });

  document.getElementById('registration-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    const actionContainer = document.getElementById('registration-action');
    const errorContainer = document.getElementById('registration-error');
    const registerButtonElement = document.getElementById('register-button');
    const registerButton = registerButtonElement instanceof HTMLButtonElement ? registerButtonElement : null;

    // Clear previous error
    if (errorContainer) {
      errorContainer.textContent = '';
      errorContainer.classList.add('hidden');
    }

    // Loading state
    let originalButtonHTML = null;
    if (registerButton) {
      originalButtonHTML = registerButton.innerHTML;
      registerButton.disabled = true;
      registerButton.classList.add('opacity-60', 'cursor-not-allowed');
      registerButton.setAttribute('aria-busy', 'true');
      registerButton.innerHTML = `
        <span class="inline-flex items-center gap-3">
          <svg class="animate-spin h-6 w-6 text-white" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          Submitting...
        </span>
      `;
    }

    try {
      const response = await fetch('/api/signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        if (actionContainer) {
          actionContainer.setAttribute('aria-live', 'polite');
          actionContainer.innerHTML = `
            <div class="inline-block mt-2 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg text-[20px] font-semibold">
              ðŸŽ‰ You're in! We'll be in touch soon with details about the run.
            </div>
          `;
        }
        form.reset();
        // Reset mobile size buttons
        document.querySelectorAll('.size-button').forEach(btn => {
          btn.setAttribute('data-selected', 'false');
          btn.classList.remove('bg-white', 'text-gray-900', 'border-white');
          btn.classList.add('bg-gray-800', 'text-white', 'border-gray-500');
        });
      } else {
        const errorData = await response.json().catch(() => ({}));
        console.error('Server error:', errorData);
        if (errorContainer) {
          errorContainer.textContent = 'Something went wrong. Please try again.';
          errorContainer.classList.remove('hidden');
        }
        if (registerButton && originalButtonHTML !== null) {
          registerButton.disabled = false;
          registerButton.classList.remove('opacity-60', 'cursor-not-allowed');
          registerButton.removeAttribute('aria-busy');
          registerButton.innerHTML = originalButtonHTML;
        }
      }
    } catch (error) {
      console.error('Form submission error:', error);
      if (errorContainer) {
        errorContainer.textContent = 'Something went wrong. Please try again.';
        errorContainer.classList.remove('hidden');
      }
      if (registerButton && originalButtonHTML !== null) {
        registerButton.disabled = false;
        registerButton.classList.remove('opacity-60', 'cursor-not-allowed');
        registerButton.removeAttribute('aria-busy');
        registerButton.innerHTML = originalButtonHTML;
      }
    }
  });
</script>