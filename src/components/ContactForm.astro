---
// Registration form component
const shoeSizes = Array.from({ length: 11 }, (_, i) => (i + 5).toString());
const jerseyNumberMin = 0;
const jerseyNumberMax = 99;
const sizeOptions = ['XS', 'S', 'M', 'L', 'XL', 'XXL'];
---

<form id="registration-form" class="w-full" novalidate>
  <!-- Player Section -->
  <div class="flex flex-col gap-[8px] items-start w-full">
    <p class="font-roboto-condensed font-bold leading-normal relative shrink-0 text-[12px] text-white uppercase w-full">
      Player
    </p>
    
    <!-- First Name and Last Name Row -->
    <div class="flex flex-col items-start w-full">
      <div class="flex gap-[10px] items-start w-full">
        <div class="bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-1 flex-col items-center min-h-0 overflow-clip px-4 md:px-[16px] py-3 md:py-[12px] rounded-[4px]">
          <input
            type="text"
            id="first_name"
            name="first_name"
            required
            class="w-full bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-white placeholder:text-[rgba(255,255,255,0.5)]"
            placeholder="First Name"
          />
        </div>
        <div class="bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-1 flex-col items-center min-h-0 overflow-clip px-4 md:px-[16px] py-3 md:py-[12px] rounded-[4px]">
          <input
            type="text"
            id="last_name"
            name="last_name"
            required
            class="w-full bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-white placeholder:text-[rgba(255,255,255,0.5)]"
            placeholder="Last Name"
          />
        </div>
      </div>
    </div>
    
    <!-- Email Full Width (Mobile) -->
    <div class="md:hidden bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center overflow-clip px-4 py-3 rounded-[4px] w-full">
      <input
        type="email"
        id="email"
        name="email"
        required
        class="w-full bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-white placeholder:text-[rgba(255,255,255,0.5)]"
        placeholder="Email"
      />
    </div>
    
    <!-- Email and Phone Number Row (Desktop) -->
    <div class="hidden md:flex flex-col items-start w-full">
      <div class="flex gap-[10px] items-start w-full">
        <div class="bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-1 flex-col items-center min-h-0 overflow-clip px-[16px] py-[12px] rounded-[4px]">
          <input
            type="email"
            id="email_desktop"
            name="email"
            required
            class="w-full bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-white placeholder:text-[rgba(255,255,255,0.5)]"
            placeholder="Email"
          />
        </div>
        <div class="bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-1 flex-col items-center min-h-0 overflow-clip px-[16px] py-[12px] rounded-[4px]">
          <input
            type="tel"
            id="phone_desktop"
            name="phone"
            required
            class="w-full bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-white placeholder:text-[rgba(255,255,255,0.5)]"
            placeholder="Phone Number"
          />
        </div>
      </div>
    </div>
    
    <!-- Phone Number Full Width (Mobile) -->
    <div class="md:hidden bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center overflow-clip px-4 py-3 rounded-[4px] w-full">
      <input
        type="tel"
        id="phone"
        name="phone"
        required
        class="w-full bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-white placeholder:text-[rgba(255,255,255,0.5)]"
        placeholder="Phone Number"
      />
    </div>
    
    <!-- Address Full Width -->
    <div class="bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center overflow-clip px-4 md:px-[16px] py-3 md:py-[12px] rounded-[4px] w-full">
      <input
        type="text"
        id="address"
        name="address"
        required
        class="w-full bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-white placeholder:text-[rgba(255,255,255,0.5)]"
        placeholder="Address"
      />
    </div>
  </div>

  <!-- Divider -->
  <div class="bg-[rgba(255,255,255,0.5)] h-px shrink-0 w-full my-6"></div>

  <!-- Size Selection: Desktop Dropdowns / Mobile Button Grids -->
  <div class="flex flex-col gap-3 w-full">
    <!-- Top Size -->
    <div class="flex flex-col gap-2 items-start w-full">
      <!-- Desktop Dropdown (no label) -->
      <div class="hidden md:flex bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid items-start justify-between overflow-clip px-[16px] py-[12px] rounded-[4px] w-full">
        <select
          id="top_size"
          name="top_size"
          required
          class="flex-1 min-h-0 bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-[rgba(255,255,255,0.5)] appearance-none cursor-pointer"
        >
          <option value="" class="bg-[#212121] text-[rgba(255,255,255,0.5)]">Jersey Size</option>
          {sizeOptions.map(size => (
            <option value={size} class="bg-[#212121] text-white">{size}</option>
          ))}
        </select>
        <svg class="w-4 h-4 text-white shrink-0 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
      <!-- Mobile Button Grid -->
      <div class="md:hidden flex flex-col gap-2 items-start w-full">
        <p class="font-roboto-condensed font-bold leading-normal relative shrink-0 text-[12px] text-white uppercase w-full whitespace-pre-wrap">
          Jersey Size
        </p>
        <div class="flex gap-1 items-start w-full">
          {sizeOptions.map(size => (
            <button
              type="button"
              data-size-field="top_size"
              data-size-value={size}
              class="size-button bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center justify-center overflow-clip rounded-[4px] shrink-0 w-[42px] h-[42px] cursor-pointer"
            >
              <p class="font-roboto-condensed font-normal leading-normal text-[15px] text-[rgba(255,255,255,0.5)] text-center">
                {size}
              </p>
            </button>
          ))}
        </div>
        <select id="top_size_mobile" name="top_size" class="hidden">
          <option value=""></option>
          {sizeOptions.map(size => (
            <option value={size}>{size}</option>
          ))}
        </select>
      </div>
    </div>

    <!-- Jersey # (0-99) -->
    <div class="flex flex-col gap-2 items-start w-full">
      <div class="bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center overflow-clip px-4 md:px-[16px] py-3 md:py-[12px] rounded-[4px] w-full">
        <input
          type="number"
          id="jersey_number"
          name="jersey_number"
          min={jerseyNumberMin}
          max={jerseyNumberMax}
          inputmode="numeric"
          class="w-full bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-white placeholder:text-[rgba(255,255,255,0.5)]"
          placeholder="Preferred Jersey # (0-99)"
        />
      </div>
    </div> 

    <!-- Bottom Size -->
    <div class="flex flex-col gap-2 items-start w-full">
      <!-- Desktop Dropdown (no label) -->
      <div class="hidden md:flex bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid items-start justify-between overflow-clip px-[16px] py-[12px] rounded-[4px] w-full">
        <select
          id="bottom_size"
          name="bottom_size"
          required
          class="flex-1 min-h-0 bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-[rgba(255,255,255,0.5)] appearance-none cursor-pointer"
        >
          <option value="" class="bg-[#212121] text-[rgba(255,255,255,0.5)]">Shorts Size</option>
          {sizeOptions.map(size => (
            <option value={size} class="bg-[#212121] text-white">{size}</option>
          ))}
        </select>
        <svg class="w-4 h-4 text-white shrink-0 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
      <!-- Mobile Button Grid -->
      <div class="md:hidden flex flex-col gap-2 items-start w-full">
        <p class="font-roboto-condensed font-bold leading-normal relative shrink-0 text-[12px] text-white uppercase w-full whitespace-pre-wrap">
          Shorts Size
        </p>
        <div class="flex gap-1 items-start w-full">
          {sizeOptions.map(size => (
            <button
              type="button"
              data-size-field="bottom_size"
              data-size-value={size}
              class="size-button bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center justify-center overflow-clip rounded-[4px] shrink-0 w-[42px] h-[42px] cursor-pointer"
            >
              <p class="font-roboto-condensed font-normal leading-normal text-[15px] text-[rgba(255,255,255,0.5)] text-center">
                {size}
              </p>
            </button>
          ))}
        </div>
        <select id="bottom_size_mobile" name="bottom_size" class="hidden">
          <option value=""></option>
          {sizeOptions.map(size => (
            <option value={size}>{size}</option>
          ))}
        </select>
      </div>
    </div>

    <!-- Jacket/Hoodie Size -->
    <div class="flex flex-col gap-2 items-start w-full">
      <!-- Desktop Dropdown (no label) -->
      <div class="hidden md:flex bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid items-start justify-between overflow-clip px-[16px] py-[12px] rounded-[4px] w-full">
        <select
          id="jacket_size"
          name="jacket_size"
          required
          class="flex-1 min-h-0 bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-[rgba(255,255,255,0.5)] appearance-none cursor-pointer"
        >
          <option value="" class="bg-[#212121] text-[rgba(255,255,255,0.5)]">Jacket/Hoodie Size</option>
          {sizeOptions.map(size => (
            <option value={size} class="bg-[#212121] text-white">{size}</option>
          ))}
        </select>
        <svg class="w-4 h-4 text-white shrink-0 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
      <!-- Mobile Button Grid -->
      <div class="md:hidden flex flex-col gap-2 items-start w-full">
        <p class="font-roboto-condensed font-bold leading-normal relative shrink-0 text-[12px] text-white uppercase w-full whitespace-pre-wrap">
          Jacket/Hoodie Size
        </p>
        <div class="flex gap-1 items-start w-full">
          {sizeOptions.map(size => (
            <button
              type="button"
              data-size-field="jacket_size"
              data-size-value={size}
              class="size-button bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center justify-center overflow-clip rounded-[4px] shrink-0 w-[42px] h-[42px] cursor-pointer"
            >
              <p class="font-roboto-condensed font-normal leading-normal text-[15px] text-[rgba(255,255,255,0.5)] text-center">
                {size}
              </p>
            </button>
          ))}
        </div>
        <select id="jacket_size_mobile" name="jacket_size" class="hidden">
          <option value=""></option>
          {sizeOptions.map(size => (
            <option value={size}>{size}</option>
          ))}
        </select>
      </div>
    </div>

    <!-- Sports Bra Size -->
    <div class="flex flex-col gap-2 items-start w-full">
      <!-- Desktop Dropdown (no label) -->
      <div class="hidden md:flex bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid items-start justify-between overflow-clip px-[16px] py-[12px] rounded-[4px] w-full">
        <select
          id="sports_bra_size"
          name="sports_bra_size"
          class="flex-1 min-h-0 bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-[rgba(255,255,255,0.5)] appearance-none cursor-pointer"
        >
          <option value="" class="bg-[#212121] text-[rgba(255,255,255,0.5)]">Sports Bra Size</option>
          {sizeOptions.map(size => (
            <option value={size} class="bg-[#212121] text-white">{size}</option>
          ))}
        </select>
        <svg class="w-4 h-4 text-white shrink-0 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
      <!-- Mobile Button Grid -->
      <div class="md:hidden flex flex-col gap-2 items-start w-full">
        <p class="font-roboto-condensed font-bold leading-normal relative shrink-0 text-[12px] text-white uppercase w-full whitespace-pre-wrap">
          Sports Bra Size
        </p>
        <div class="flex gap-1 items-start w-full">
          {sizeOptions.map(size => (
            <button
              type="button"
              data-size-field="sports_bra_size"
              data-size-value={size}
              class="size-button bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center justify-center overflow-clip rounded-[4px] shrink-0 w-[42px] h-[42px] cursor-pointer"
            >
              <p class="font-roboto-condensed font-normal leading-normal text-[15px] text-[rgba(255,255,255,0.5)] text-center">
                {size}
              </p>
            </button>
          ))}
        </div>
        <select id="sports_bra_size_mobile" name="sports_bra_size" class="hidden">
          <option value=""></option>
          {sizeOptions.map(size => (
            <option value={size}>{size}</option>
          ))}
        </select>
      </div>
    </div>

    <!-- Tight Size -->
    <div class="flex flex-col gap-2 items-start w-full">
      <!-- Desktop Dropdown (no label) -->
      <div class="hidden md:flex bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid items-start justify-between overflow-clip px-[16px] py-[12px] rounded-[4px] w-full">
        <select
          id="tight_size"
          name="tight_size"
          required
          class="flex-1 min-h-0 bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-[rgba(255,255,255,0.5)] appearance-none cursor-pointer"
        >
          <option value="" class="bg-[#212121] text-[rgba(255,255,255,0.5)]">Compression Tights Size</option>
          {sizeOptions.map(size => (
            <option value={size} class="bg-[#212121] text-white">{size}</option>
          ))}
        </select>
        <svg class="w-4 h-4 text-white shrink-0 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
      <!-- Mobile Button Grid -->
      <div class="md:hidden flex flex-col gap-2 items-start w-full">
        <p class="font-roboto-condensed font-bold leading-normal relative shrink-0 text-[12px] text-white uppercase w-full whitespace-pre-wrap">
          Compression Tights Size
        </p>
        <div class="flex gap-1 items-start w-full">
          {sizeOptions.map(size => (
            <button
              type="button"
              data-size-field="tight_size"
              data-size-value={size}
              class="size-button bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center justify-center overflow-clip rounded-[4px] shrink-0 w-[42px] h-[42px] cursor-pointer"
            >
              <p class="font-roboto-condensed font-normal leading-normal text-[15px] text-[rgba(255,255,255,0.5)] text-center">
                {size}
              </p>
            </button>
          ))}
        </div>
        <select id="tight_size_mobile" name="tight_size" class="hidden">
          <option value=""></option>
          {sizeOptions.map(size => (
            <option value={size}>{size}</option>
          ))}
        </select>
      </div>
    </div>

    <!-- Shoe Size -->
    <div class="flex flex-col gap-2 items-start w-full">
      <!-- Desktop Dropdown (no label) -->
      <div class="hidden md:flex bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid items-start justify-between overflow-clip px-[16px] py-[12px] rounded-[4px] w-full">
        <select
          id="shoe_size"
          name="shoe_size"
          required
          class="flex-1 min-h-0 bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-[rgba(255,255,255,0.5)] appearance-none cursor-pointer"
        >
          <option value="" class="bg-[#212121] text-[rgba(255,255,255,0.5)]">Shoe Size (Mens)</option>
          {shoeSizes.map(size => (
            <option value={size} class="bg-[#212121] text-white">{size}</option>
          ))}
        </select>
        <svg class="w-4 h-4 text-white shrink-0 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
      <!-- Mobile Button Grid (7 columns x 2 rows) -->
      <div class="md:hidden flex flex-col gap-2 items-start w-full">
        <p class="font-roboto-condensed font-bold leading-normal relative shrink-0 text-[12px] text-white uppercase w-full whitespace-pre-wrap">
          Shoe Size (Mens)
        </p>
        <div class="grid grid-cols-7 gap-1 h-[88px] w-full">
          {shoeSizes.map((size, index) => (
            <button
              type="button"
              data-size-field="shoe_size"
              data-size-value={size}
              class="size-button bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center justify-center overflow-clip rounded-[4px] shrink-0 w-[42px] h-[42px] cursor-pointer"
            >
              <p class="font-roboto-condensed font-normal leading-normal text-[15px] text-[rgba(255,255,255,0.5)] text-center">
                {size}
              </p>
            </button>
          ))}
        </div>
        <select id="shoe_size_mobile" name="shoe_size" class="hidden">
          <option value=""></option>
          {shoeSizes.map(size => (
            <option value={size}>{size}</option>
          ))}
        </select>
      </div>
    </div>
  </div>

  <!-- Divider -->
  <div class="bg-[rgba(255,255,255,0.5)] h-px shrink-0 w-full my-1 mt-6"></div>

  <!-- Alternative Contact Section -->
  <div class="flex flex-col gap-[8px] items-start overflow-clip w-full">
    <p class="font-roboto-condensed font-bold leading-normal relative shrink-0 text-[12px] text-white uppercase w-full whitespace-pre-wrap">
      Alternative Contact
    </p>
    
    <!-- First Name and Last Name Row -->
    <div class="flex gap-[10px] items-start w-full">
      <div class="bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-1 flex-col items-center min-h-0 overflow-clip px-4 md:px-[16px] py-3 md:py-[12px] rounded-[4px]">
        <input
          type="text"
          id="alternative_contact_first_name"
          name="alternative_contact_first_name"
          required
          class="w-full bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-white placeholder:text-[rgba(255,255,255,0.5)]"
          placeholder="First Name"
        />
      </div>
      <div class="bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-1 flex-col items-center min-h-0 overflow-clip px-4 md:px-[16px] py-3 md:py-[12px] rounded-[4px]">
        <input
          type="text"
          id="alternative_contact_last_name"
          name="alternative_contact_last_name"
          required
          class="w-full bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-white placeholder:text-[rgba(255,255,255,0.5)]"
          placeholder="Last Name"
        />
      </div>
    </div>
    
    <!-- Phone Number Full Width -->
    <div class="bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center overflow-clip px-4 md:px-[16px] py-3 md:py-[12px] rounded-[4px] w-full">
      <input
        type="tel"
        id="alternative_contact_phone"
        name="alternative_contact_phone"
        required
        class="w-full bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-white placeholder:text-[rgba(255,255,255,0.5)]"
        placeholder="Phone Number"
      />
    </div>
    
    <!-- Email Full Width (required for API but not shown in Figma design - keeping visible) -->
    <div class="bg-[#212121] border border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center overflow-clip px-4 md:px-[16px] py-3 md:py-[12px] rounded-[4px] w-full">
      <input
        type="email"
        id="alternative_contact_email"
        name="alternative_contact_email"
        required
        class="w-full bg-transparent border-0 outline-0 font-roboto-condensed font-normal leading-normal text-[15px] text-white placeholder:text-[rgba(255,255,255,0.5)]"
        placeholder="Email"
      />
    </div>
  </div>

  <!-- Inline error box (hidden by default) -->
  <div
    id="registration-error"
    class="hidden mt-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg text-[18px] text-center"
    aria-live="polite"
  ></div>
</form>

<script>
  // Mobile size button handler
  document.querySelectorAll('.size-button').forEach(button => {
    button.addEventListener('click', function(this: HTMLButtonElement) {
      const fieldName = this.getAttribute('data-size-field');
      const sizeValue = this.getAttribute('data-size-value');
      
      if (!fieldName || !sizeValue) return;
      
      // Try desktop select first, then mobile select
      let selectElement = document.getElementById(fieldName) as HTMLSelectElement;
      if (!selectElement) {
        selectElement = document.getElementById(`${fieldName}_mobile`) as HTMLSelectElement;
      }
      
      if (!selectElement) return;
      
      // Update select value
      selectElement.value = sizeValue;
      
      // Update all buttons in this group
      const allButtons = document.querySelectorAll(`[data-size-field="${fieldName}"]`);
      allButtons.forEach(btn => {
        const isSelected = btn === this;
        const buttonElement = btn as HTMLButtonElement;
        const textElement = buttonElement.querySelector('p');
        
        if (isSelected) {
          // Selected: white background, dark text, dark border
          buttonElement.classList.remove('bg-[#212121]', 'border-[rgba(255,255,255,0.5)]');
          buttonElement.classList.add('bg-white', 'border-[#212121]');
          if (textElement) {
            textElement.classList.remove('text-[rgba(255,255,255,0.5)]');
            textElement.classList.add('text-[#212121]');
          }
        } else {
          // Unselected: dark background, white text, white border
          buttonElement.classList.remove('bg-white', 'border-[#212121]');
          buttonElement.classList.add('bg-[#212121]', 'border-[rgba(255,255,255,0.5)]');
          if (textElement) {
            textElement.classList.remove('text-[#212121]');
            textElement.classList.add('text-[rgba(255,255,255,0.5)]');
          }
        }
      });
    });
  });

  document.getElementById('registration-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const form = e.target as HTMLFormElement;
    
    // Remove required attribute from hidden fields to prevent validation errors
    const hiddenRequiredFields = form.querySelectorAll('input[required], select[required]');
    hiddenRequiredFields.forEach((field: Element) => {
      const htmlField = field as HTMLElement;
      // Check if field is hidden (using display: none or visibility: hidden)
      const style = window.getComputedStyle(htmlField);
      if (style.display === 'none' || style.visibility === 'hidden' || htmlField.classList.contains('hidden')) {
        htmlField.removeAttribute('required');
      }
    });
    
    // Also check parent containers
    const allRequiredFields = form.querySelectorAll('input[required], select[required]');
    allRequiredFields.forEach((field: Element) => {
      const htmlField = field as HTMLElement;
      let parent = htmlField.parentElement;
      let isHidden = false;
      while (parent && parent !== form) {
        const parentStyle = window.getComputedStyle(parent);
        if (parentStyle.display === 'none' || parent.classList.contains('hidden')) {
          isHidden = true;
          break;
        }
        parent = parent.parentElement;
      }
      if (isHidden) {
        htmlField.removeAttribute('required');
      }
    });
    
    const formData = new FormData(form);
    
    // Sync mobile/desktop email and phone fields
    const emailMobile = document.getElementById('email') as HTMLInputElement;
    const emailDesktop = document.getElementById('email_desktop') as HTMLInputElement;
    const phoneMobile = document.getElementById('phone') as HTMLInputElement;
    const phoneDesktop = document.getElementById('phone_desktop') as HTMLInputElement;
    
    if (emailMobile && emailDesktop) {
      const emailValue = emailMobile.value || emailDesktop.value;
      emailMobile.value = emailValue;
      emailDesktop.value = emailValue;
    }
    if (phoneMobile && phoneDesktop) {
      const phoneValue = phoneMobile.value || phoneDesktop.value;
      phoneMobile.value = phoneValue;
      phoneDesktop.value = phoneValue;
    }
    
    // Sync mobile size selects with desktop selects
    const sizeFields = ['top_size', 'bottom_size', 'jacket_size', 'sports_bra_size', 'tight_size', 'shoe_size'];
    sizeFields.forEach(fieldName => {
      const desktopSelect = document.getElementById(fieldName) as HTMLSelectElement | null;
      const mobileSelect = document.getElementById(`${fieldName}_mobile`) as HTMLSelectElement | null;
      
      let finalValue = '';
      
      if (desktopSelect && mobileSelect) {
        // Both exist - sync them
        finalValue = desktopSelect.value || mobileSelect.value;
        desktopSelect.value = finalValue;
        mobileSelect.value = finalValue;
      } else if (desktopSelect) {
        // Only desktop exists
        finalValue = desktopSelect.value;
        if (mobileSelect && !finalValue) {
          finalValue = mobileSelect.value;
          desktopSelect.value = finalValue;
        }
      } else if (mobileSelect) {
        // Only mobile exists
        finalValue = mobileSelect.value;
      }
      
      // Ensure FormData has the value
      if (finalValue) {
        formData.set(fieldName, finalValue);
      }
    });
    
    // Combine first_name and last_name into name for backend compatibility
    const data: Record<string, string> = {};
    for (const [key, value] of formData.entries()) {
      // Skip individual name fields as we'll combine them
      if (key === 'first_name' || key === 'last_name' || 
          key === 'alternative_contact_first_name' || key === 'alternative_contact_last_name') {
        continue;
      }
      // Only include non-empty values
      const stringValue = value.toString().trim();
      if (stringValue) {
        data[key] = stringValue;
      }
    }
    
    // Combine names
    const firstName = formData.get('first_name')?.toString()?.trim() || '';
    const lastName = formData.get('last_name')?.toString()?.trim() || '';
    data.name = `${firstName} ${lastName}`.trim();
    
    // Combine alternative contact names
    const altFirstName = formData.get('alternative_contact_first_name')?.toString()?.trim() || '';
    const altLastName = formData.get('alternative_contact_last_name')?.toString()?.trim() || '';
    data.alternative_contact_name = `${altFirstName} ${altLastName}`.trim();
    
    // Debug: Log the data being sent
    console.log('Form data being sent:', data);
    
    // Get UI elements
    const errorContainer = document.getElementById('registration-error');
    const submitButtonWrapper = document.getElementById('submit-button-wrapper') as HTMLButtonElement;
    const submitButtonText = submitButtonWrapper?.querySelector('span') as HTMLSpanElement;
    
    // Clear previous error
    if (errorContainer) {
      errorContainer.textContent = '';
      errorContainer.classList.add('hidden');
    }
    
    // Set loading state IMMEDIATELY to prevent multiple clicks
    let originalButtonHTML = null;
    let isSubmitting = false;
    
    if (submitButtonWrapper) {
      // Check if already submitting to prevent double-clicks
      if (submitButtonWrapper.disabled || submitButtonWrapper.getAttribute('aria-busy') === 'true') {
        return; // Already submitting, ignore this click
      }
      
      // Disable button immediately (synchronous)
      submitButtonWrapper.disabled = true;
      submitButtonWrapper.setAttribute('aria-busy', 'true');
      submitButtonWrapper.style.opacity = '0.6';
      submitButtonWrapper.style.cursor = 'not-allowed';
      isSubmitting = true;
      
      // Update button text
      if (submitButtonText) {
        originalButtonHTML = submitButtonText.innerHTML;
        submitButtonText.innerHTML = 'SUBMITTING...';
      }
    }
    
    // Validate required fields before submission
    const requiredFields = [
      'name',
      'email',
      'phone',
      'alternative_contact_name',
      'alternative_contact_phone',
      'alternative_contact_email',
      'address',
      'top_size',
      'bottom_size',
      'jacket_size',
      'tight_size',
      'shoe_size'
    ];
    
    // Map field names to their display names (placeholders)
    const fieldDisplayNames: Record<string, string> = {
      'name': 'Name',
      'email': 'Email',
      'phone': 'Phone Number',
      'alternative_contact_name': 'Alternative Contact Name',
      'alternative_contact_phone': 'Alternative Contact Phone',
      'alternative_contact_email': 'Alternative Contact Email',
      'address': 'Address',
      'top_size': 'Jersey Size',
      'bottom_size': 'Shorts Size',
      'jacket_size': 'Jacket/Hoodie Size',
      'tight_size': 'Compression Tight Size',
      'shoe_size': 'Shoe Size (Mens)'
    };
    
    const missingFields = requiredFields.filter(field => !data[field] || data[field].trim() === '');
    
    if (missingFields.length > 0) {
      console.error('Missing required fields:', missingFields);
      // Reset button state if validation fails
      if (submitButtonWrapper && isSubmitting) {
        submitButtonWrapper.disabled = false;
        submitButtonWrapper.removeAttribute('aria-busy');
        submitButtonWrapper.style.opacity = '1';
        submitButtonWrapper.style.cursor = 'pointer';
        if (submitButtonText && originalButtonHTML !== null) {
          submitButtonText.innerHTML = originalButtonHTML;
        }
      }
      if (errorContainer) {
        const missingFieldNames = missingFields.map(field => fieldDisplayNames[field] || field);
        errorContainer.textContent = `Please fill in all required fields. Missing: ${missingFieldNames.join(', ')}`;
        errorContainer.classList.remove('hidden');
      }
      return;
    }

    try {
      const response = await fetch('/api/signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        // Redirect to success page
        window.location.href = '/players/success';
      } else {
        const errorData = await response.json().catch(() => ({}));
        console.error('Server error:', errorData);
        if (errorContainer) {
          let errorMessage = 'Something went wrong. Please try again.';
          if (errorData.missing && Array.isArray(errorData.missing)) {
            // Map field names to display names for error message
            const fieldDisplayNames: Record<string, string> = {
              'name': 'Name',
              'email': 'Email',
              'phone': 'Phone Number',
              'alternative_contact_name': 'Alternative Contact Name',
              'alternative_contact_phone': 'Alternative Contact Phone',
              'alternative_contact_email': 'Alternative Contact Email',
              'address': 'Address',
              'top_size': 'Jersey Size',
              'bottom_size': 'Shorts Size',
              'jacket_size': 'Jacket/Hoodie Size',
              'tight_size': 'Compression Tight Size',
              'shoe_size': 'Shoe Size (Mens)'
            };
            const missingFieldNames = errorData.missing.map((field: string) => fieldDisplayNames[field] || field);
            errorMessage = `Please fill in all required fields. Missing: ${missingFieldNames.join(', ')}`;
          } else if (errorData.error) {
            errorMessage = errorData.error;
          }
          errorContainer.textContent = errorMessage;
          errorContainer.classList.remove('hidden');
        }
        if (submitButtonWrapper && isSubmitting) {
          submitButtonWrapper.disabled = false;
          submitButtonWrapper.removeAttribute('aria-busy');
          submitButtonWrapper.style.opacity = '1';
          submitButtonWrapper.style.cursor = 'pointer';
          if (submitButtonText && originalButtonHTML !== null) {
            submitButtonText.innerHTML = originalButtonHTML;
          }
        }
      }
    } catch (error) {
      console.error('Form submission error:', error);
      if (errorContainer) {
        errorContainer.textContent = 'Something went wrong. Please try again.';
        errorContainer.classList.remove('hidden');
      }
      if (submitButtonWrapper && isSubmitting) {
        submitButtonWrapper.disabled = false;
        submitButtonWrapper.removeAttribute('aria-busy');
        submitButtonWrapper.style.opacity = '1';
        submitButtonWrapper.style.cursor = 'pointer';
        if (submitButtonText && originalButtonHTML !== null) {
          submitButtonText.innerHTML = originalButtonHTML;
        }
      }
    }
  });
</script>
