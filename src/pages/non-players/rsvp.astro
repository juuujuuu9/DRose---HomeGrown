---
import Layout from '../../layouts/Layout.astro';

// Desktop logos from non-players.astro
const imgDerrickRoseDesktop = "https://www.figma.com/api/mcp/asset/1e346d4c-6df8-425d-8567-97003bcfbbe1";
const imgHomegrownCursiveDesktop = "https://www.figma.com/api/mcp/asset/ee0ae443-0dba-4ebc-994c-4d92329058d6";
// Mobile logos
const imgDerrickRoseMobile = "https://www.figma.com/api/mcp/asset/44ae098a-0d6e-40ab-9e62-e928bac7c3f6";
const imgHomegrownCursiveMobile = "https://www.figma.com/api/mcp/asset/aaa531a4-5a7c-4c3f-b36d-e045c6f12dd5";
---

<Layout title="RSVP | Non-Players" description="HOMEGROWN AT SIMEON">
  <style>
    body {
      background-color: #000000;
    }
  </style>

  <!-- Desktop Layout -->
  <main class="hidden lg:flex min-h-screen bg-black relative overflow-hidden rounded-3xl">
    <!-- Main Container with border -->
    <div class="w-full h-dvh bg-[#F5F5F5] flex animate-fade-in">
      <!-- Left Section: Background Image -->
      <div class="w-1/2 h-full relative bg-white">
        <img 
          alt="Urban basketball court with elevated train tracks" 
          class="w-full h-full object-cover" 
          src="/bg-photo.png" 
        />
      </div>

      <!-- Right Section: Form -->
      <div class="w-1/2 h-full bg-[#F5F5F5] flex flex-col px-12 pt-8 overflow-y-auto">
        <!-- Logo Section -->
        <div class="flex flex-col items-center gap-[10px] pt-4 pb-10">
          <div class="h-[79px] w-[81px] relative">
            <img alt="Derrick Rose logo" class="w-full h-full object-contain" src={imgDerrickRoseDesktop} />
          </div>
          <div class="h-[110px] w-[418px] relative">
            <img alt="Homegrown" class="w-full h-full object-contain" src={imgHomegrownCursiveDesktop} />
          </div>
        </div>

        <!-- Form -->
        <form id="non-player-form" class="flex flex-col gap-6 flex-1">
          <!-- Name Field -->
          <div class="flex flex-col gap-2 px-12">
            <input
              type="text"
              id="name"
              name="name"
              required
              class="w-full bg-white border border-gray-300 rounded px-4 py-3 text-gray-900 placeholder:text-gray-400 font-roboto-condensed text-[15px] outline-none focus:border-[#CE1141] focus:ring-1 focus:ring-[#CE1141]"
              placeholder="Name (First and Last)"
            />
          </div>

          <!-- Email Field -->
          <div class="flex flex-col gap-2 px-12">
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full bg-white border border-gray-300 rounded px-4 py-3 text-gray-900 placeholder:text-gray-400 font-roboto-condensed text-[15px] outline-none focus:border-[#CE1141] focus:ring-1 focus:ring-[#CE1141]"
              placeholder="Email"
            />
          </div>

          <!-- Phone Number Field -->
          <div class="flex flex-col gap-2 px-12">
            <input
              type="tel"
              id="phone"
              name="phone"
              required
              class="w-full bg-white border border-gray-300 rounded px-4 py-3 text-gray-900 placeholder:text-gray-400 font-roboto-condensed text-[15px] outline-none focus:border-[#CE1141] focus:ring-1 focus:ring-[#CE1141]"
              placeholder="Phone Number"
            />
          </div>

          <!-- Guests Section -->
          <div class="px-12 flex flex-col gap-4">
            <div class="border border-black rounded p-4">
            <label class="text-gray-700 font-roboto-condensed text-[14px] font-semibold uppercase">
              Guests (Up to 4)
            </label>
            
            <!-- Guest 1 -->
            <div id="guests-container" class="flex flex-col gap-4">
              <div class="guest-group" data-guest-index="1">
                <label class="text-gray-700 font-roboto-condensed text-[12px] font-semibold uppercase mb-2 block">
                  GUEST 1
                </label>
                <div class="flex gap-3">
                  <input
                    type="text"
                    name="guest_1_first"
                    placeholder="First Name"
                    class="flex-1 bg-white border border-gray-300 rounded px-4 py-3 text-gray-900 placeholder:text-gray-400 font-roboto-condensed text-[15px] outline-none focus:border-[#CE1141] focus:ring-1 focus:ring-[#CE1141]"
                  />
                  <input
                    type="text"
                    name="guest_1_last"
                    placeholder="Last Name"
                    class="flex-1 bg-white border border-gray-300 rounded px-4 py-3 text-gray-900 placeholder:text-gray-400 font-roboto-condensed text-[15px] outline-none focus:border-[#CE1141] focus:ring-1 focus:ring-[#CE1141]"
                  />
                </div>
              </div>
            </div>

            <!-- Add Guest Button -->
            <button
              type="button"
              id="add-guest-btn"
              class="bg-[#CE1141] hover:bg-[#a00d33] text-white px-4 py-2 rounded text-[14px] mt-4 font-roboto-condensed font-semibold uppercase transition-colors duration-200 self-start"
            >
              + Add Guest
            </button>
          </div>
          </div>

          <!-- Submit Button / Inline Confirmation Area -->
          <div id="registration-action" class="text-center pt-4" aria-live="polite">
            <button
              id="register-button"
              type="submit"
              class="w-full bg-[#CE1141] hover:bg-[#a00d33] text-white py-4 px-8 rounded text-[18px] font-prohibition font-bold uppercase tracking-wider transition-colors duration-200"
            >
              SUBMIT
            </button>
          </div>

          <!-- Disclaimer -->
          <div class="pt-2 px-12 mx-auto">
            <p class="text-gray-600 text-[13px] text-center font-roboto-condensed leading-relaxed max-w-[500px]">
              Please note, this does not guarantee entry. Names will be confirmed and tickets will be issued the week prior to the event, with final tickets sent the day before or day of the event.
            </p>
          </div>

          <!-- Inline error box (hidden by default) -->
          <div
            id="registration-error"
            class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg text-[15px] text-center font-roboto-condensed"
            aria-live="polite"
          ></div>
        </form>

        <!-- Footer -->
        <div class="flex items-center justify-between pt-6 mt-auto">
          <div class="border border-gray-900 px-3 py-1.5">
            <p class="text-[13px] uppercase tracking-[0.75px] text-gray-900 font-normal font-roboto-condensed">
              HOMEGROWN AT SIMEON
            </p>
          </div>
          <div class="flex items-center gap-2">
            <div class="text-right">
              <p class="text-[13px] uppercase text-gray-900 font-bold font-roboto-condensed">HOME</p>
              <p class="text-[13px] uppercase text-gray-900 font-bold font-roboto-condensed">GAME</p>
            </div>
            <div class="bg-[#CE1141] text-white w-10 h-16 flex items-center justify-center">
              <span class="font-prohibition text-[36px] tracking-[7.20px] pb-[7px]">1</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Mobile Layout -->
  <main class="lg:hidden min-h-screen bg-black flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-[#F5F5F5] rounded-lg overflow-hidden animate-fade-in">
      <!-- Logo Section -->
      <div class="flex flex-col items-center gap-[10px] pt-8 pb-6">
        <div class="h-[60px] w-[61.535px] relative">
          <img alt="Derrick Rose logo" class="w-full h-full object-contain" src={imgDerrickRoseMobile} />
        </div>
        <div class="h-[84px] w-[320px] relative">
          <img alt="Homegrown" class="w-full h-full object-contain" src={imgHomegrownCursiveMobile} />
        </div>
      </div>

      <!-- Form -->
      <form id="non-player-form-mobile" class="flex flex-col gap-4 px-6 pb-6">
        <!-- Name Field -->
        <input
          type="text"
          id="name-mobile"
          name="name"
          required
          class="w-full bg-white border border-gray-300 rounded px-4 py-3 text-gray-900 placeholder:text-gray-400 font-roboto-condensed text-[15px] outline-none focus:border-[#CE1141] focus:ring-1 focus:ring-[#CE1141]"
          placeholder="Name (First and Last)"
        />

        <!-- Email Field -->
        <input
          type="email"
          id="email-mobile"
          name="email"
          required
          class="w-full bg-white border border-gray-300 rounded px-4 py-3 text-gray-900 placeholder:text-gray-400 font-roboto-condensed text-[15px] outline-none focus:border-[#CE1141] focus:ring-1 focus:ring-[#CE1141]"
          placeholder="Email"
        />

        <!-- Phone Number Field -->
        <input
          type="tel"
          id="phone-mobile"
          name="phone"
          required
          class="w-full bg-white border border-gray-300 rounded px-4 py-3 text-gray-900 placeholder:text-gray-400 font-roboto-condensed text-[15px] outline-none focus:border-[#CE1141] focus:ring-1 focus:ring-[#CE1141]"
          placeholder="Phone Number"
        />

        <!-- Guests Section -->
        <div class="bg-gray-200 border border-gray-300 rounded p-4 flex flex-col gap-4">
          <label class="text-gray-700 font-roboto-condensed text-[14px] font-semibold uppercase">
            Guests (Up to 4)
          </label>
          
          <!-- Guest 1 -->
          <div id="guests-container-mobile" class="flex flex-col gap-4">
            <div class="guest-group" data-guest-index="1">
              <label class="text-gray-700 font-roboto-condensed text-[12px] font-semibold uppercase mb-2 block">
                GUEST 1
              </label>
              <div class="flex flex-col gap-3">
                <input
                  type="text"
                  name="guest_1_first"
                  placeholder="First Name"
                  class="w-full bg-white border border-gray-300 rounded px-4 py-3 text-gray-900 placeholder:text-gray-400 font-roboto-condensed text-[15px] outline-none focus:border-[#CE1141] focus:ring-1 focus:ring-[#CE1141]"
                />
                <input
                  type="text"
                  name="guest_1_last"
                  placeholder="Last Name"
                  class="w-full bg-white border border-gray-300 rounded px-4 py-3 text-gray-900 placeholder:text-gray-400 font-roboto-condensed text-[15px] outline-none focus:border-[#CE1141] focus:ring-1 focus:ring-[#CE1141]"
                />
              </div>
            </div>
          </div>

          <!-- Add Guest Button -->
          <button
            type="button"
            id="add-guest-btn-mobile"
            class="bg-[#CE1141] hover:bg-[#a00d33] text-white px-4 py-2 rounded text-[14px] font-roboto-condensed font-semibold uppercase transition-colors duration-200 self-start"
          >
            + Add Guest
          </button>
        </div>

        <!-- Submit Button / Inline Confirmation Area -->
        <div id="registration-action-mobile" class="text-center pt-4" aria-live="polite">
          <button
            id="register-button-mobile"
            type="submit"
            class="w-full bg-[#CE1141] hover:bg-[#a00d33] text-white py-4 px-8 rounded text-[18px] font-prohibition font-bold uppercase tracking-wider transition-colors duration-200"
          >
            SUBMIT
          </button>
        </div>

        <!-- Disclaimer -->
        <div class="pt-2">
          <p class="text-gray-600 text-[13px] font-roboto-condensed leading-relaxed">
            Please note, this does not guarantee entry. Names will be confirmed and tickets will be issued the week prior to the event, with final tickets sent the day before or day of the event.
          </p>
        </div>

        <!-- Inline error box (hidden by default) -->
        <div
          id="registration-error-mobile"
          class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg text-[15px] text-center font-roboto-condensed"
          aria-live="polite"
        ></div>
      </form>

      <!-- Footer -->
      <div class="flex items-center justify-between px-6 pb-6 border-t border-gray-300 pt-4">
        <div class="border border-gray-900 px-3 py-1.5">
          <p class="text-[13px] uppercase tracking-[0.75px] text-gray-900 font-normal font-roboto-condensed">
            HOMEGROWN AT SIMEON
          </p>
        </div>
        <div class="flex items-center gap-2">
          <div class="text-right">
            <p class="text-[13px] uppercase text-gray-900 font-bold font-roboto-condensed">HOME</p>
            <p class="text-[13px] uppercase text-gray-900 font-bold font-roboto-condensed">GAME</p>
          </div>
          <div class="bg-[#CE1141] text-white w-10 h-16 flex items-center justify-center">
            <span class="font-prohibition text-[28px] tracking-[7.20px] pb-[7px]">1</span>
          </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  // Guest management for desktop
  let guestCount = 1;
  const maxGuests = 4;
  const addGuestBtn = document.getElementById('add-guest-btn') as HTMLButtonElement | null;
  const guestsContainer = document.getElementById('guests-container');

  addGuestBtn?.addEventListener('click', () => {
    if (guestCount >= maxGuests) {
      if (addGuestBtn) {
        addGuestBtn.disabled = true;
        addGuestBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }
      return;
    }

    guestCount++;
    const guestGroup = document.createElement('div');
    guestGroup.className = 'guest-group';
    guestGroup.setAttribute('data-guest-index', guestCount.toString());
    guestGroup.innerHTML = `
      <label class="text-gray-700 font-roboto-condensed text-[12px] font-semibold uppercase mb-2 block">
        GUEST ${guestCount}
      </label>
      <div class="flex gap-3">
        <input
          type="text"
          name="guest_${guestCount}_first"
          placeholder="First Name"
          class="flex-1 bg-white border border-gray-300 rounded px-4 py-3 text-gray-900 placeholder:text-gray-400 font-roboto-condensed text-[15px] outline-none focus:border-[#CE1141] focus:ring-1 focus:ring-[#CE1141]"
        />
        <input
          type="text"
          name="guest_${guestCount}_last"
          placeholder="Last Name"
          class="flex-1 bg-white border border-gray-300 rounded px-4 py-3 text-gray-900 placeholder:text-gray-400 font-roboto-condensed text-[15px] outline-none focus:border-[#CE1141] focus:ring-1 focus:ring-[#CE1141]"
        />
      </div>
    `;
    guestsContainer?.appendChild(guestGroup);

    if (guestCount >= maxGuests && addGuestBtn) {
      addGuestBtn.disabled = true;
      addGuestBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
  });

  // Guest management for mobile
  let guestCountMobile = 1;
  const addGuestBtnMobile = document.getElementById('add-guest-btn-mobile') as HTMLButtonElement | null;
  const guestsContainerMobile = document.getElementById('guests-container-mobile');

  addGuestBtnMobile?.addEventListener('click', () => {
    if (guestCountMobile >= maxGuests) {
      if (addGuestBtnMobile) {
        addGuestBtnMobile.disabled = true;
        addGuestBtnMobile.classList.add('opacity-50', 'cursor-not-allowed');
      }
      return;
    }

    guestCountMobile++;
    const guestGroup = document.createElement('div');
    guestGroup.className = 'guest-group';
    guestGroup.setAttribute('data-guest-index', guestCountMobile.toString());
    guestGroup.innerHTML = `
      <label class="text-gray-700 font-roboto-condensed text-[12px] font-semibold uppercase mb-2 block">
        GUEST ${guestCountMobile}
      </label>
      <div class="flex flex-col gap-3">
        <input
          type="text"
          name="guest_${guestCountMobile}_first"
          placeholder="First Name"
          class="w-full bg-white border border-gray-300 rounded px-4 py-3 text-gray-900 placeholder:text-gray-400 font-roboto-condensed text-[15px] outline-none focus:border-[#CE1141] focus:ring-1 focus:ring-[#CE1141]"
        />
        <input
          type="text"
          name="guest_${guestCountMobile}_last"
          placeholder="Last Name"
          class="w-full bg-white border border-gray-300 rounded px-4 py-3 text-gray-900 placeholder:text-gray-400 font-roboto-condensed text-[15px] outline-none focus:border-[#CE1141] focus:ring-1 focus:ring-[#CE1141]"
        />
      </div>
    `;
    guestsContainerMobile?.appendChild(guestGroup);

    if (guestCountMobile >= maxGuests && addGuestBtnMobile) {
      addGuestBtnMobile.disabled = true;
      addGuestBtnMobile.classList.add('opacity-50', 'cursor-not-allowed');
    }
  });

  // Form submission handler for desktop
  document.getElementById('non-player-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    await handleFormSubmit(e.target as HTMLFormElement, 'registration-action', 'registration-error', 'register-button');
  });

  // Form submission handler for mobile
  document.getElementById('non-player-form-mobile')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    await handleFormSubmit(e.target as HTMLFormElement, 'registration-action-mobile', 'registration-error-mobile', 'register-button-mobile');
  });

  async function handleFormSubmit(
    form: HTMLFormElement,
    actionContainerId: string,
    errorContainerId: string,
    buttonId: string
  ) {
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Collect guest information and convert to API format
    const additionalTickets: Array<{ name: string; email: string; phone: string }> = [];
    for (let i = 1; i <= maxGuests; i++) {
      const first = (data[`guest_${i}_first`] as string)?.trim();
      const last = (data[`guest_${i}_last`] as string)?.trim();
      if (first && last) {
        // Use main contact's email/phone for guests (as per mockup, guests only have names)
        additionalTickets.push({
          name: `${first} ${last}`,
          email: (data.email as string) || '',
          phone: (data.phone as string) || ''
        });
      }
    }

    // Calculate ticket count (main person + guests)
    const ticketCount = 1 + additionalTickets.length;

    const payload = {
      name: data.name,
      email: data.email,
      phone: data.phone,
      ticket_count: ticketCount,
      additional_tickets: additionalTickets
    };

    const actionContainer = document.getElementById(actionContainerId);
    const errorContainer = document.getElementById(errorContainerId);
    const registerButton = document.getElementById(buttonId);

    // Clear previous error
    if (errorContainer) {
      errorContainer.textContent = '';
      errorContainer.classList.add('hidden');
    }

    // Loading state
    let originalButtonHTML = null;
    if (registerButton) {
      originalButtonHTML = registerButton.innerHTML;
      registerButton.setAttribute('disabled', 'true');
      registerButton.classList.add('opacity-60', 'cursor-not-allowed');
      registerButton.setAttribute('aria-busy', 'true');
      registerButton.innerHTML = `
        <span class="inline-flex items-center gap-3">
          <svg class="animate-spin h-5 w-5 text-white" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          Submitting...
        </span>
      `;
    }

    try {
      const response = await fetch('/api/non-player-signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        if (actionContainer) {
          actionContainer.setAttribute('aria-live', 'polite');
          actionContainer.innerHTML = `
            <div class="inline-block mt-2 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg text-[16px] font-semibold font-roboto-condensed">
              ðŸŽ‰ You're in! We'll be in touch soon with details about the event.
            </div>
          `;
        }
        form.reset();
        // Reset guest containers
        if (guestsContainer) {
          guestsContainer.innerHTML = `
            <div class="guest-group" data-guest-index="1">
              <label class="text-gray-700 font-roboto-condensed text-[12px] font-semibold uppercase mb-2 block">
                GUEST 1
              </label>
              <div class="flex gap-3">
                <input
                  type="text"
                  name="guest_1_first"
                  placeholder="First Name"
                  class="flex-1 bg-white border border-gray-300 rounded px-4 py-3 text-gray-900 placeholder:text-gray-400 font-roboto-condensed text-[15px] outline-none focus:border-[#CE1141] focus:ring-1 focus:ring-[#CE1141]"
                />
                <input
                  type="text"
                  name="guest_1_last"
                  placeholder="Last Name"
                  class="flex-1 bg-white border border-gray-300 rounded px-4 py-3 text-gray-900 placeholder:text-gray-400 font-roboto-condensed text-[15px] outline-none focus:border-[#CE1141] focus:ring-1 focus:ring-[#CE1141]"
                />
              </div>
            </div>
          `;
          guestCount = 1;
          if (addGuestBtn) {
            addGuestBtn.disabled = false;
            addGuestBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          }
        }
        if (guestsContainerMobile) {
          guestsContainerMobile.innerHTML = `
            <div class="guest-group" data-guest-index="1">
              <label class="text-gray-700 font-roboto-condensed text-[12px] font-semibold uppercase mb-2 block">
                GUEST 1
              </label>
              <div class="flex flex-col gap-3">
                <input
                  type="text"
                  name="guest_1_first"
                  placeholder="First Name"
                  class="w-full bg-white border border-gray-300 rounded px-4 py-3 text-gray-900 placeholder:text-gray-400 font-roboto-condensed text-[15px] outline-none focus:border-[#CE1141] focus:ring-1 focus:ring-[#CE1141]"
                />
                <input
                  type="text"
                  name="guest_1_last"
                  placeholder="Last Name"
                  class="w-full bg-white border border-gray-300 rounded px-4 py-3 text-gray-900 placeholder:text-gray-400 font-roboto-condensed text-[15px] outline-none focus:border-[#CE1141] focus:ring-1 focus:ring-[#CE1141]"
                />
              </div>
            </div>
          `;
          guestCountMobile = 1;
          if (addGuestBtnMobile) {
            addGuestBtnMobile.disabled = false;
            addGuestBtnMobile.classList.remove('opacity-50', 'cursor-not-allowed');
          }
        }
      } else {
        const errorData = await response.json().catch(() => ({}));
        console.error('Server error:', errorData);
        if (errorContainer) {
          errorContainer.textContent = 'Something went wrong. Please try again.';
          errorContainer.classList.remove('hidden');
        }
        if (registerButton && originalButtonHTML !== null) {
          registerButton.removeAttribute('disabled');
          registerButton.classList.remove('opacity-60', 'cursor-not-allowed');
          registerButton.removeAttribute('aria-busy');
          registerButton.innerHTML = originalButtonHTML;
        }
      }
    } catch (error) {
      console.error('Form submission error:', error);
      if (errorContainer) {
        errorContainer.textContent = 'Something went wrong. Please try again.';
        errorContainer.classList.remove('hidden');
      }
      if (registerButton && originalButtonHTML !== null) {
        registerButton.removeAttribute('disabled');
        registerButton.classList.remove('opacity-60', 'cursor-not-allowed');
        registerButton.removeAttribute('aria-busy');
        registerButton.innerHTML = originalButtonHTML;
      }
    }
  }
</script>

<style>
  /* Apply Roboto Condensed to all text on this page, except Prohibition font */
  main,
  main *:not(.font-prohibition) {
    font-family: 'Roboto Condensed', sans-serif !important;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fadeIn 0.6s ease-out forwards;
  }
</style>
