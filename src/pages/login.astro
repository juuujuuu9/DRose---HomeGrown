---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Admin Login">
  <main class="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4">
    <div class="max-w-md w-full bg-white rounded-lg shadow-lg p-8">
      <h1 class="text-3xl font-bold text-center mb-8 text-gray-900">Admin Login</h1>
      
      <form id="login-form" class="space-y-6">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-2">
            Username
          </label>
          <input
            type="text"
            id="username"
            name="username"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
            autocomplete="username"
          />
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
            Password
          </label>
          <input
            type="password"
            id="password"
            name="password"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
            autocomplete="current-password"
          />
        </div>

        <!-- Submit Button / Inline Confirmation Area -->
        <div id="login-action" class="pt-4" aria-live="polite">
          <button
            id="login-button"
            type="submit"
            class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 transition-colors"
          >
            Login
          </button>
        </div>

        <!-- Inline error box (hidden by default) -->
        <div
          id="login-error"
          class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg text-center"
          aria-live="polite"
        ></div>
      </form>
    </div>
  </main>
</Layout>

<script>
  document.getElementById('login-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    const actionContainer = document.getElementById('login-action');
    const errorContainer = document.getElementById('login-error');
    const loginButton = document.getElementById('login-button') as HTMLButtonElement;

    // Clear previous error
    if (errorContainer) {
      errorContainer.textContent = '';
      errorContainer.classList.add('hidden');
    }

    // Loading state
    let originalButtonHTML = null;
    if (loginButton) {
      originalButtonHTML = loginButton.innerHTML;
      loginButton.disabled = true;
      loginButton.classList.add('opacity-60', 'cursor-not-allowed');
      loginButton.setAttribute('aria-busy', 'true');
      loginButton.innerHTML = `
        <span class="inline-flex items-center justify-center gap-2">
          <svg class="animate-spin h-5 w-5 text-white" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          Logging in...
        </span>
      `;
    }

    try {
      const response = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        // Redirect to admin page
        window.location.href = '/admin';
      } else {
        const errorData = await response.json().catch(() => ({}));
        console.error('Login error:', errorData);
        if (errorContainer) {
          errorContainer.textContent = errorData.error || 'Invalid username or password. Please try again.';
          errorContainer.classList.remove('hidden');
        }
        if (loginButton && originalButtonHTML !== null) {
          loginButton.disabled = false;
          loginButton.classList.remove('opacity-60', 'cursor-not-allowed');
          loginButton.removeAttribute('aria-busy');
          loginButton.innerHTML = originalButtonHTML;
        }
      }
    } catch (error) {
      console.error('Login submission error:', error);
      if (errorContainer) {
        errorContainer.textContent = 'Something went wrong. Please try again.';
        errorContainer.classList.remove('hidden');
      }
      if (loginButton && originalButtonHTML !== null) {
        loginButton.disabled = false;
        loginButton.classList.remove('opacity-60', 'cursor-not-allowed');
        loginButton.removeAttribute('aria-busy');
        loginButton.innerHTML = originalButtonHTML;
      }
    }
  });
</script>

