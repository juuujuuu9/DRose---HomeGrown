---
import Layout from '../layouts/Layout.astro';
import { isAuthenticated } from '../lib/auth';
import { 
  getAllSubmissions, 
  getAllNonPlayerSubmissions, 
  initializeDatabase,
  initializeNonPlayerDatabase 
} from '../lib/database';
import type { Submission, NonPlayerSubmission } from '../lib/database';

// Check authentication
if (!isAuthenticated(Astro.cookies)) {
  return Astro.redirect('/login', 302);
}

// Initialize database schemas (ensures migrations run)
try {
  await initializeDatabase();
  await initializeNonPlayerDatabase();
} catch (error) {
  console.error('Error initializing database:', error);
  console.error('Error details:', error instanceof Error ? error.message : String(error));
  // Continue - tables may already exist
}

// Fetch entries server-side
let entries: Submission[] = [];
let nonPlayerEntries: NonPlayerSubmission[] = [];

try {
  entries = await getAllSubmissions();
} catch (error) {
  console.error('Error fetching player submissions:', error);
  console.error('Error details:', error instanceof Error ? error.message : String(error));
  // Continue with empty array to prevent page crash
}

try {
  nonPlayerEntries = await getAllNonPlayerSubmissions();
} catch (error) {
  console.error('Error fetching non-player submissions:', error);
  console.error('Error details:', error instanceof Error ? error.message : String(error));
  // Continue with empty array to prevent page crash
}

// Helper function to split name
function splitName(name: string): { firstName: string; lastName: string } {
  const parts = name.trim().split(/\s+/);
  return {
    firstName: parts[0] || '',
    lastName: parts.slice(1).join(' ') || ''
  };
}

// Desktop background images from Figma (updated URLs)
const imgRsvpPagePlayersOnlyFormOpt3 = "https://www.figma.com/api/mcp/asset/b61944d2-0df1-4e37-95e1-42b45a13e9fa";
// Mobile background images from Figma
const imgRsvpPagePlayersOnlyFormMobile = "https://www.figma.com/api/mcp/asset/b53e319b-a7bb-4131-b717-1b5005bc5e65";
const imgRsvpPagePlayersOnlyFormMobile1 = "https://www.figma.com/api/mcp/asset/cec3d09d-efa4-48f2-b208-83b3f6fb2210";
// Desktop logos
const imgDerrickRoseDesktop = "/assets/Derrick%20Rose.svg";
const imgHomegrownCursiveDesktop = "/assets/Homegrown%20Cursive.svg";
// Mobile logos
const imgDerrickRoseMobile = "/assets/Derrick%20Rose.svg";
const imgHomegrownCursiveMobile = "/assets/Homegrown%20Cursive.svg";
---

<Layout title="Admin Dashboard">
  <div class="relative min-h-screen py-4 px-2 bg-black overflow-hidden">
    <!-- Background Images - Desktop -->
    <div aria-hidden="true" class="hidden lg:block fixed inset-0 pointer-events-none z-0">
      <div class="absolute bg-black inset-0"></div>
      <img 
        alt="" 
        class="absolute max-w-none object-cover size-full opacity-50" 
        src={imgRsvpPagePlayersOnlyFormOpt3} 
      />
    </div>
    
    <!-- Background Images - Mobile -->
    <div aria-hidden="true" class="lg:hidden fixed inset-0 pointer-events-none z-0">
      <div class="absolute bg-black inset-0"></div>
      <img 
        alt="" 
        class="absolute max-w-none object-cover size-full opacity-50" 
        src={imgRsvpPagePlayersOnlyFormMobile} 
      />
      <img 
        alt="" 
        class="absolute max-w-none object-cover size-full opacity-50" 
        src={imgRsvpPagePlayersOnlyFormMobile1} 
      />
    </div>

    <!-- Header -->
    <div class="relative z-10 flex justify-between items-center mb-4 pb-2 border-b border-[rgba(255,255,255,0.3)] max-w-7xl mx-auto animate-fade-in">
        <div class="flex flex-row gap-4">
            <a href="/" class="overflow-clip py-[10px] ml-3">
              <!-- Mobile: Derrick Rose Logo -->
              <div class="lg:hidden h-[60px] relative shrink-0 w-[61.535px]">
                <img alt="Derrick Rose" class="block max-w-none size-full" src={imgDerrickRoseMobile} />
              </div>
              <!-- Desktop: Derrick Rose Logo -->
              <div class="hidden lg:block h-[79px] relative shrink-0 w-[81px]">
                <img alt="Derrick Rose" class="block max-w-none size-full" src={imgDerrickRoseDesktop} />
              </div>
            </a>
        </div>

        <div class="flex gap-2">
          <!-- Export CSVs Button -->
            <button
            id="export-csv-btn"
            class="px-3 py-2 border border-[rgba(255,255,255,0.5)] rounded-[4px] text-white bg-[#212121] hover:bg-[#2a2a2a] transition-colors flex items-center gap-2.5 font-roboto-condensed font-semibold uppercase text-sm"
            >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Export CSVs
            </button>
            <button
            id="logout-btn"
            class="px-3 py-2 border border-[rgba(255,255,255,0.5)] rounded-[4px] text-white bg-[#212121] hover:bg-[#2a2a2a] transition-colors flex items-center gap-2.5 font-roboto-condensed font-semibold uppercase text-sm"
            >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            Logout
            </button>
        </div>
    </div>

    <div class="relative z-10 max-w-7xl mx-auto bg-[#212121]/25 backdrop-blur-sm rounded-xl border border-[rgba(255,255,255,0.2)] shadow-md p-2 animate-fade-in">
      <!-- Search and Filter Section -->
      <div class="flex flex-col sm:flex-row gap-2 mb-3 sm:items-center">
        <div class="flex-1 relative w-full">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <svg class="w-5 h-5 text-[rgba(255,255,255,0.5)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          <input
            type="text"
            id="search-input"
            placeholder="SEARCH ENTRIES"
            class="w-full pl-12 pr-5 py-3.5 border border-[rgba(255,255,255,0.5)] rounded-[4px] bg-[#1a1a1a] text-white placeholder:text-[rgba(255,255,255,0.5)] focus:outline-none focus:ring-2 focus:ring-[#ce1141] focus:border-[#ce1141] font-roboto-condensed font-semibold uppercase text-sm"
          />
        </div>
        <div class="relative w-full sm:w-auto">
          <button
            id="sort-btn"
            class="w-full sm:w-auto px-3 py-3.5 border border-[rgba(255,255,255,0.5)] rounded-[4px] text-white bg-[#212121] hover:bg-[#2a2a2a] transition-colors flex items-center gap-2 font-roboto-condensed font-semibold uppercase text-sm sm:min-w-[140px] justify-between"
            aria-expanded="false"
            aria-haspopup="true"
          >
            <span class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
              </svg>
              <span id="sort-label">Name (A-Z)</span>
            </span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div
            id="sort-dropdown"
            class="hidden absolute right-0 mt-2 w-48 bg-[#212121] rounded-[4px] shadow-lg border border-[rgba(255,255,255,0.3)] z-50"
          >
            <button
              class="sort-option w-full text-left px-4 py-3 text-sm font-roboto-condensed font-semibold uppercase text-white hover:bg-[#2a2a2a] transition-colors flex items-center justify-between"
              data-sort="name-asc"
            >
              <span>Name (A-Z)</span>
              <svg class="w-4 h-4 hidden check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </button>
            <button
              class="sort-option w-full text-left px-4 py-3 text-sm font-roboto-condensed font-semibold uppercase text-white hover:bg-[#2a2a2a] transition-colors flex items-center justify-between border-t border-[rgba(255,255,255,0.2)]"
              data-sort="name-desc"
            >
              <span>Name (Z-A)</span>
              <svg class="w-4 h-4 hidden check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </button>
            <button
              class="sort-option w-full text-left px-4 py-3 text-sm font-roboto-condensed font-semibold uppercase text-white hover:bg-[#2a2a2a] transition-colors flex items-center justify-between border-t border-[rgba(255,255,255,0.2)]"
              data-sort="date"
            >
              <span>Date</span>
              <svg class="w-4 h-4 hidden check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </button>
          </div>
        </div>
        <p class="text-sm font-roboto-condensed font-semibold text-[rgba(255,255,255,0.7)] uppercase tracking-wide text-center sm:text-left pr-3">
            Total <span id="entry-count" class="font-bold text-white">{entries.length + nonPlayerEntries.length}</span> Entries
        </p>
      </div>

      <!-- Title and Tabs Section -->
      <div class="mb-4 border-b border-[rgba(255,255,255,0.3)] pb-2">
        <div class="flex flex-col sm:flex-row justify-center sm:justify-between items-center gap-4 pl-3 md:pt-6 md:pb-0">
          <h2 id="section-title" class="text-2xl font-prohibition text-[#ce1141] uppercase tracking-wider text-center sm:text-left">Player Entries</h2>
          <div class="inline-flex bg-[#1a1a1a] rounded-lg p-1 border border-[rgba(255,255,255,0.2)]">
            <button
              id="tab-players"
              class="tab-btn px-6 py-2.5 text-sm font-roboto-condensed font-semibold uppercase tracking-wide rounded-md bg-[#ce1141] text-white transition-all duration-100"
              data-tab="players"
            >
              Players (<span id="players-count">{entries.length}</span>)
            </button>
            <button
              id="tab-non-players"
              class="tab-btn px-6 py-2.5 text-sm font-roboto-condensed font-semibold uppercase tracking-wide rounded-md bg-transparent text-[rgba(255,255,255,0.7)] transition-all duration-100"
              data-tab="non-players"
            >
              Non-Players (<span id="non-players-count">{nonPlayerEntries.length}</span>)
            </button>
          </div>
        </div>
      </div>

      <!-- Players Table Section -->
      <div id="players-table-section" class="tab-content">

        <div class="overflow-x-auto rounded-xl border border-[rgba(255,255,255,0.2)] bg-[#1a1a1a]">
          {entries.length === 0 ? (
            <div class="text-center py-16 text-[rgba(255,255,255,0.7)]">
              <p class="text-lg font-roboto-condensed font-semibold mb-2">No player entries found.</p>
              <p class="text-sm font-roboto-condensed">Entries will appear here once users submit the RSVP form.</p>
            </div>
          ) : (
            <table class="w-full border-collapse min-w-full">
              <thead>
                <tr class="bg-[#212121]">
                  <th class="w-auto px-2 py-2 text-left text-sm font-roboto-condensed font-bold text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-[rgba(255,255,255,0.3)]">Check-In</th>
                  <th class="px-2 py-2 text-left text-sm font-roboto-condensed font-bold text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-[rgba(255,255,255,0.3)] border-l border-[rgba(255,255,255,0.2)]">Name</th>
                  <th class="px-2 py-2 text-left text-sm font-roboto-condensed font-bold text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-[rgba(255,255,255,0.3)] border-l border-[rgba(255,255,255,0.2)]">Email</th>
                  <th class="px-2 py-2 text-left text-sm font-roboto-condensed font-bold text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-[rgba(255,255,255,0.3)] border-l border-[rgba(255,255,255,0.2)]">Phone</th>
                  <th class="px-2 py-2 text-left text-sm font-roboto-condensed font-bold text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-[rgba(255,255,255,0.3)] border-l border-[rgba(255,255,255,0.2)]">Alt. Contact Name</th>
                  <th class="px-2 py-2 text-left text-sm font-roboto-condensed font-bold text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-[rgba(255,255,255,0.3)] border-l border-[rgba(255,255,255,0.2)]">Alt. Contact Phone</th>
                  <th class="px-2 py-2 text-left text-sm font-roboto-condensed font-bold text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-[rgba(255,255,255,0.3)] border-l border-[rgba(255,255,255,0.2)]">Alt. Contact Email</th>
                  <th class="px-2 py-2 text-left text-sm font-roboto-condensed font-bold text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-[rgba(255,255,255,0.3)] border-l border-[rgba(255,255,255,0.2)]">Address</th>
                  <th class="px-2 py-2 text-left text-sm font-roboto-condensed font-bold text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-[rgba(255,255,255,0.3)] border-l border-[rgba(255,255,255,0.2)]">Sizes</th>
                  <th class="px-2 py-2 text-center text-sm font-roboto-condensed font-bold text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-[rgba(255,255,255,0.3)] border-l border-[rgba(255,255,255,0.2)]">Actions</th>
                </tr>
              </thead>
              <tbody id="entries-tbody" class="divide-y divide-[rgba(255,255,255,0.1)]">
                {entries.map((entry) => {
                const checkInStatus = entry.checked_in ? 'ATTENDING' : 'CHECK-IN';
                const checkInColor = entry.checked_in 
                  ? 'bg-green-600 text-white border border-green-500' 
                  : 'bg-[#ce1141] text-white border border-[#b01038]';
                const { firstName } = splitName(entry.name || '');
                const dateValue = typeof entry.created_at === 'string' 
                  ? new Date(entry.created_at).toISOString()
                  : (entry.created_at as Date).toISOString();
                const sizes = [
                  entry.top_size ? `Jersey: ${entry.top_size}` : null,
                  entry.jersey_number ? `Jersey #: ${entry.jersey_number}` : null,
                  entry.preferred_jersey_number ? `Preferred jersey #: ${entry.preferred_jersey_number}` : null,
                  entry.bottom_size ? `Shorts: ${entry.bottom_size}` : null,
                  entry.jacket_size ? `Jacket: ${entry.jacket_size}` : null,
                  entry.tight_size ? `Tight: ${entry.tight_size}` : null,
                  entry.shoe_size ? `Shoe (mens): ${entry.shoe_size}` : null
                ].filter(Boolean).join(', ') || '—';
                
                return (
                  <tr 
                    class="hover:bg-[#2a2a2a] transition-colors" 
                    data-entry-id={entry.id}
                    data-first-name={firstName.toLowerCase()}
                    data-created-at={dateValue}
                  >
                    <td class="w-auto px-2 py-2 whitespace-nowrap">
                      <label class="cursor-pointer inline-flex items-center justify-center">
                        <input
                          type="checkbox"
                          class="sr-only check-in-checkbox"
                          data-entry-id={entry.id}
                          checked={entry.checked_in || false}
                        />
                        <span class={`inline-flex items-center justify-center w-8 h-8 rounded-full text-xs font-roboto-condensed font-bold uppercase tracking-wide ${checkInColor}`}>
                          {entry.checked_in ? (
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
                            </svg>
                          ) : (
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <circle cx="12" cy="12" r="9" stroke-width="2" />
                            </svg>
                          )}
                        </span>
                      </label>
                    </td>
                    <td class="px-2 py-2 text-md font-roboto-condensed font-semibold text-white capitalize border-l border-[rgba(255,255,255,0.1)] whitespace-nowrap">{entry.name || '—'}</td>
                    <td class="px-2 py-2 text-md font-roboto-condensed font-semibold text-white border-l border-[rgba(255,255,255,0.1)] whitespace-nowrap">{entry.email}</td>
                    <td class="px-2 py-2 text-md font-roboto-condensed font-semibold text-white border-l border-[rgba(255,255,255,0.1)] whitespace-nowrap">{entry.phone || '—'}</td>
                    <td class="px-2 py-2 text-md font-roboto-condensed font-semibold text-white border-l border-[rgba(255,255,255,0.1)] whitespace-nowrap">{entry.alternative_contact_name || '—'}</td>
                    <td class="px-2 py-2 text-md font-roboto-condensed font-semibold text-white border-l border-[rgba(255,255,255,0.1)] whitespace-nowrap">{entry.alternative_contact_phone || '—'}</td>
                    <td class="px-2 py-2 text-md font-roboto-condensed font-semibold text-white border-l border-[rgba(255,255,255,0.1)] whitespace-nowrap">{entry.alternative_contact_email || '—'}</td>
                    <td class="px-2 py-2 text-md font-roboto-condensed font-semibold text-white border-l border-[rgba(255,255,255,0.1)] whitespace-nowrap">{entry.address || '—'}</td>
                    <td class="px-2 py-2 text-md font-roboto-condensed font-semibold text-white border-l border-[rgba(255,255,255,0.1)] whitespace-nowrap">{sizes}</td>
                    <td class="px-2 py-2 text-center border-l border-[rgba(255,255,255,0.1)] whitespace-nowrap">
                      <button
                        class="delete-entry-btn px-3 py-1.5 bg-[#ce1141] text-white rounded-[4px] hover:bg-[#b01038] transition-colors text-sm font-roboto-condensed font-semibold uppercase flex items-center gap-2 mx-auto"
                        data-entry-id={entry.id}
                        data-entry-name={entry.name}
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    </td>
                  </tr>
                );
                })}
              </tbody>
            </table>
          )}
        </div>
      </div>

      <!-- Non-Players Table Section -->
      <div id="non-players-table-section" class="tab-content hidden">

        <div class="overflow-x-auto rounded-xl border border-[rgba(255,255,255,0.2)] bg-[#1a1a1a]">
          {nonPlayerEntries.length === 0 ? (
            <div class="text-center py-16 text-[rgba(255,255,255,0.7)]">
              <p class="text-lg font-roboto-condensed font-semibold mb-2">No non-player entries found.</p>
              <p class="text-sm font-roboto-condensed">Entries will appear here once users submit the non-player form.</p>
            </div>
          ) : (
            <table class="w-full border-collapse min-w-full">
              <thead>
                <tr class="bg-[#212121]">
                  <th class="px-2 py-2 text-left text-sm font-roboto-condensed font-bold text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-[rgba(255,255,255,0.3)]">Name</th>
                  <th class="px-2 py-2 text-left text-sm font-roboto-condensed font-bold text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-[rgba(255,255,255,0.3)] border-l border-[rgba(255,255,255,0.2)]">Email</th>
                  <th class="px-2 py-2 text-left text-sm font-roboto-condensed font-bold text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-[rgba(255,255,255,0.3)] border-l border-[rgba(255,255,255,0.2)]">Phone</th>
                  <th class="px-2 py-2 text-left text-sm font-roboto-condensed font-bold text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-[rgba(255,255,255,0.3)] border-l border-[rgba(255,255,255,0.2)]">Ticket Count</th>
                  <th class="px-2 py-2 text-left text-sm font-roboto-condensed font-bold text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-[rgba(255,255,255,0.3)] border-l border-[rgba(255,255,255,0.2)]">Additional Tickets</th>
                  <th class="px-2 py-2 text-center text-sm font-roboto-condensed font-bold text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-[rgba(255,255,255,0.3)] border-l border-[rgba(255,255,255,0.2)]">Actions</th>
                </tr>
              </thead>
              <tbody id="non-player-entries-tbody" class="divide-y divide-[rgba(255,255,255,0.1)]">
                {nonPlayerEntries.map((entry) => {
                const { firstName } = splitName(entry.name || '');
                const dateValue = typeof entry.created_at === 'string' 
                  ? new Date(entry.created_at).toISOString()
                  : (entry.created_at as Date).toISOString();
                const additionalTickets = entry.additional_tickets && entry.additional_tickets.length > 0
                  ? entry.additional_tickets
                    .map((ticket: { name: string; email: string; phone: string }) => `${ticket.name} (${ticket.email}, ${ticket.phone})`)
                    .join(', ')
                  : '—';
                
                return (
                  <tr 
                    class="hover:bg-[#2a2a2a] transition-colors" 
                    data-entry-id={entry.id}
                    data-first-name={firstName.toLowerCase()}
                    data-created-at={dateValue}
                  >
                    <td class="px-2 py-2 text-md font-roboto-condensed font-semibold text-white capitalize whitespace-nowrap">{entry.name || '—'}</td>
                    <td class="px-2 py-2 text-md font-roboto-condensed font-semibold text-white border-l border-[rgba(255,255,255,0.1)] whitespace-nowrap">{entry.email}</td>
                    <td class="px-2 py-2 text-md font-roboto-condensed font-semibold text-white border-l border-[rgba(255,255,255,0.1)] whitespace-nowrap">{entry.phone || '—'}</td>
                    <td class="px-2 py-2 text-md font-roboto-condensed font-semibold text-white border-l border-[rgba(255,255,255,0.1)] whitespace-nowrap">{entry.ticket_count}</td>
                    <td class="px-2 py-2 text-md font-roboto-condensed font-semibold text-white border-l border-[rgba(255,255,255,0.1)] whitespace-nowrap">{additionalTickets}</td>
                    <td class="px-2 py-2 text-center border-l border-[rgba(255,255,255,0.1)] whitespace-nowrap">
                      <button
                        class="delete-non-player-entry-btn px-3 py-1.5 bg-[#ce1141] text-white rounded-[4px] hover:bg-[#b01038] transition-colors text-sm font-roboto-condensed font-semibold uppercase flex items-center gap-2 mx-auto"
                        data-entry-id={entry.id}
                        data-entry-name={entry.name}
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    </td>
                  </tr>
                );
                })}
              </tbody>
            </table>
          )}
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fadeIn 0.6s ease-out forwards;
  }
</style>

<script>
  // Helper function to split name
  function splitName(name: string): { firstName: string; lastName: string } {
    const parts = name.trim().split(/\s+/);
    return {
      firstName: parts[0] || '',
      lastName: parts.slice(1).join(' ') || ''
    };
  }

  // Get current active tab
  function getActiveTab(): string {
    const activeTab = document.querySelector('.tab-btn.bg-\\[\\#ce1141\\]');
    return activeTab?.getAttribute('data-tab') || 'players';
  }

  // Get all entries from the active table
  function getAllEntries(): HTMLElement[] {
    const activeTab = getActiveTab();
    const tbodyId = activeTab === 'players' ? 'entries-tbody' : 'non-player-entries-tbody';
    return Array.from(document.querySelectorAll(`#${tbodyId} tr`));
  }

  // Filter entries based on search query - filters both tables
  function filterEntries(query: string): void {
    const lowerQuery = query.toLowerCase().trim();
    
    // Filter player entries
    const playersTbody = document.getElementById('entries-tbody');
    if (playersTbody) {
      const playerEntries = Array.from(playersTbody.querySelectorAll('tr'));
      
      if (lowerQuery.length < 2) {
        playerEntries.forEach(entry => {
          (entry as HTMLElement).style.display = '';
        });
      } else {
        playerEntries.forEach(entry => {
          const firstName = entry.getAttribute('data-first-name') || '';
          const name = entry.querySelector('td:nth-child(2)')?.textContent?.toLowerCase() || '';
          const email = entry.querySelector('td:nth-child(3)')?.textContent?.toLowerCase() || '';
          const phone = entry.querySelector('td:nth-child(4)')?.textContent?.toLowerCase() || '';
          const alternativeContact = entry.querySelector('td:nth-child(5)')?.textContent?.toLowerCase() || '';
          const address = entry.querySelector('td:nth-child(6)')?.textContent?.toLowerCase() || '';
          
          const matches = firstName.includes(lowerQuery) || 
            name.includes(lowerQuery) || 
            email.includes(lowerQuery) ||
            phone.includes(lowerQuery) ||
            alternativeContact.includes(lowerQuery) ||
            address.includes(lowerQuery);
          
          (entry as HTMLElement).style.display = matches ? '' : 'none';
        });
      }
    }
    
    // Filter non-player entries
    const nonPlayersTbody = document.getElementById('non-player-entries-tbody');
    if (nonPlayersTbody) {
      const nonPlayerEntries = Array.from(nonPlayersTbody.querySelectorAll('tr'));
      
      if (lowerQuery.length < 2) {
        nonPlayerEntries.forEach(entry => {
          (entry as HTMLElement).style.display = '';
        });
      } else {
        nonPlayerEntries.forEach(entry => {
          const firstName = entry.getAttribute('data-first-name') || '';
          const name = entry.querySelector('td:nth-child(1)')?.textContent?.toLowerCase() || '';
          const email = entry.querySelector('td:nth-child(2)')?.textContent?.toLowerCase() || '';
          const phone = entry.querySelector('td:nth-child(3)')?.textContent?.toLowerCase() || '';
          const additionalTickets = entry.querySelector('td:nth-child(5)')?.textContent?.toLowerCase() || '';
          
          const matches = firstName.includes(lowerQuery) || 
            name.includes(lowerQuery) || 
            email.includes(lowerQuery) ||
            phone.includes(lowerQuery) ||
            additionalTickets.includes(lowerQuery);
          
          (entry as HTMLElement).style.display = matches ? '' : 'none';
        });
      }
    }
    
    updateEntryCount();
  }

  // Update entry count display - shows total of visible entries from both tables
  function updateEntryCount(): void {
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const searchQuery = searchInput?.value?.trim() || '';
    
    // Count visible entries from both tables
    const playersTbody = document.getElementById('entries-tbody');
    const nonPlayersTbody = document.getElementById('non-player-entries-tbody');
    
    let totalCount = 0;
    
    // Count visible player entries
    if (playersTbody) {
      const playerRows = Array.from(playersTbody.querySelectorAll('tr'));
      const visiblePlayers = playerRows.filter(row => {
        const style = (row as HTMLElement).style.display;
        return style !== 'none';
      });
      totalCount += visiblePlayers.length;
    }
    
    // Count visible non-player entries
    if (nonPlayersTbody) {
      const nonPlayerRows = Array.from(nonPlayersTbody.querySelectorAll('tr'));
      const visibleNonPlayers = nonPlayerRows.filter(row => {
        const style = (row as HTMLElement).style.display;
        return style !== 'none';
      });
      totalCount += visibleNonPlayers.length;
    }
    
    const countEl = document.getElementById('entry-count');
    if (countEl) {
      countEl.textContent = String(totalCount);
    }
  }

  // Sort entries
  let currentSort: string = 'name-asc';
  
  function sortEntries(sortType: string): void {
    currentSort = sortType;
    const activeTab = getActiveTab();
    const tbodyId = activeTab === 'players' ? 'entries-tbody' : 'non-player-entries-tbody';
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;
    
    const entries = Array.from(tbody.querySelectorAll('tr'));
    // For players: name is 2nd column (after check-in), for non-players: name is 1st column
    const nameCol = activeTab === 'players' ? 2 : 1;
    
    entries.sort((a, b) => {
      if (sortType === 'name-asc') {
        const nameA = (a.querySelector(`td:nth-child(${nameCol})`)?.textContent || '').toLowerCase();
        const nameB = (b.querySelector(`td:nth-child(${nameCol})`)?.textContent || '').toLowerCase();
        return nameA.localeCompare(nameB);
      } else if (sortType === 'name-desc') {
        const nameA = (a.querySelector(`td:nth-child(${nameCol})`)?.textContent || '').toLowerCase();
        const nameB = (b.querySelector(`td:nth-child(${nameCol})`)?.textContent || '').toLowerCase();
        return nameB.localeCompare(nameA);
      } else if (sortType === 'date') {
        const dateA = new Date(a.getAttribute('data-created-at') || '').getTime();
        const dateB = new Date(b.getAttribute('data-created-at') || '').getTime();
        return dateB - dateA;
      }
      return 0;
    });
    
    entries.forEach(entry => tbody.appendChild(entry));
    
    // Update sort label
    const sortLabel = document.getElementById('sort-label');
    if (sortLabel) {
      if (sortType === 'name-asc') sortLabel.textContent = 'Name (A-Z)';
      else if (sortType === 'name-desc') sortLabel.textContent = 'Name (Z-A)';
      else if (sortType === 'date') sortLabel.textContent = 'Date';
    }
    
    // Update check icons
    document.querySelectorAll('.sort-option').forEach(option => {
      const icon = option.querySelector('.check-icon');
      if (option.getAttribute('data-sort') === sortType) {
        icon?.classList.remove('hidden');
      } else {
        icon?.classList.add('hidden');
      }
    });
  }

  // Switch tabs
  function switchTab(tabName: string): void {
    // Update tab buttons - switch style
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('bg-[#ce1141]', 'text-white');
      btn.classList.add('bg-transparent', 'text-[rgba(255,255,255,0.7)]');
    });
    
    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    if (activeBtn) {
      activeBtn.classList.remove('bg-transparent', 'text-[rgba(255,255,255,0.7)]');
      activeBtn.classList.add('bg-[#ce1141]', 'text-white');
    }
    
    // Update section title
    const sectionTitle = document.getElementById('section-title');
    if (sectionTitle) {
      sectionTitle.textContent = tabName === 'players' ? 'Player Entries' : 'Non-Player Entries';
    }
    
    // Show/hide table sections
    const playersSection = document.getElementById('players-table-section');
    const nonPlayersSection = document.getElementById('non-players-table-section');
    
    if (tabName === 'players') {
      playersSection?.classList.remove('hidden');
      nonPlayersSection?.classList.add('hidden');
    } else {
      playersSection?.classList.add('hidden');
      nonPlayersSection?.classList.remove('hidden');
    }
    
    // Re-apply current search filter (which will update entry count)
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    if (searchInput?.value) {
      filterEntries(searchInput.value);
    } else {
      updateEntryCount();
    }
  }

  // Export CSV - downloads both Players and Non-Players CSVs
  async function exportCSV(): Promise<void> {
    try {
      // Download Players CSV
      const playersResponse = await fetch('/api/admin/entries/export');
      if (!playersResponse.ok) {
        throw new Error('Failed to export players CSV');
      }
      const playersBlob = await playersResponse.blob();
      const playersUrl = window.URL.createObjectURL(playersBlob);
      const playersLink = document.createElement('a');
      playersLink.href = playersUrl;
      playersLink.download = `players-entries-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(playersLink);
      playersLink.click();
      document.body.removeChild(playersLink);
      window.URL.revokeObjectURL(playersUrl);

      // Small delay to ensure first download starts
      await new Promise(resolve => setTimeout(resolve, 500));

      // Download Non-Players CSV
      const nonPlayersResponse = await fetch('/api/admin/entries/export-non-players');
      if (!nonPlayersResponse.ok) {
        throw new Error('Failed to export non-players CSV');
      }
      const nonPlayersBlob = await nonPlayersResponse.blob();
      const nonPlayersUrl = window.URL.createObjectURL(nonPlayersBlob);
      const nonPlayersLink = document.createElement('a');
      nonPlayersLink.href = nonPlayersUrl;
      nonPlayersLink.download = `non-players-entries-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(nonPlayersLink);
      nonPlayersLink.click();
      document.body.removeChild(nonPlayersLink);
      window.URL.revokeObjectURL(nonPlayersUrl);
    } catch (error) {
      console.error('Error exporting CSVs:', error);
      alert('Failed to export CSVs. Please try again.');
    }
  }

  // Update check-in status
  async function updateCheckIn(entryId: string, checkedIn: boolean): Promise<void> {
    try {
      const response = await fetch(`/api/admin/entries/${entryId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ checked_in: checkedIn })
      });
      
      if (!response.ok) {
        throw new Error('Failed to update check-in status');
      }
      
      // Update UI
      const row = document.querySelector(`tr[data-entry-id="${entryId}"]`);
      if (row) {
        const checkbox = row.querySelector('.check-in-checkbox') as HTMLInputElement;
        const statusSpan = row.querySelector('td:first-child span');
        
        if (checkbox) checkbox.checked = checkedIn;
        if (statusSpan) {
          statusSpan.className = checkedIn
            ? 'inline-flex items-center justify-center w-8 h-8 rounded-full text-xs font-roboto-condensed font-bold uppercase tracking-wide bg-green-600 text-white border border-green-500'
            : 'inline-flex items-center justify-center w-8 h-8 rounded-full text-xs font-roboto-condensed font-bold uppercase tracking-wide bg-[#ce1141] text-white border border-[#b01038]';
          statusSpan.innerHTML = checkedIn
            ? `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" /></svg>`
            : `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke-width="2" /></svg>`;
        }
      }
    } catch (error) {
      console.error('Error updating check-in:', error);
      alert('Failed to update check-in status. Please try again.');
    }
  }

  // Delete entry
  async function deleteEntry(entryId: string, entryName: string): Promise<void> {
    if (!confirm(`Are you sure you want to delete the entry for ${entryName}?`)) {
      return;
    }
    
    try {
      const response = await fetch(`/api/admin/entries/${entryId}`, {
        method: 'DELETE'
      });
      
      if (!response.ok) {
        throw new Error('Failed to delete entry');
      }
      
      // Remove row from table
      const row = document.querySelector(`tr[data-entry-id="${entryId}"]`);
      if (row) {
        row.remove();
        // Update players count
        const playersCount = document.querySelectorAll('#entries-tbody tr').length;
        const playersCountEl = document.getElementById('players-count');
        if (playersCountEl) playersCountEl.textContent = String(playersCount);
        // Update total count (which includes both tables)
        updateEntryCount();
      }
    } catch (error) {
      console.error('Error deleting entry:', error);
      alert('Failed to delete entry. Please try again.');
    }
  }

  // Delete non-player entry
  async function deleteNonPlayerEntry(entryId: string, entryName: string): Promise<void> {
    if (!confirm(`Are you sure you want to delete the entry for ${entryName}?`)) {
      return;
    }
    
    try {
      // For now, we'll need to create an API endpoint for this
      // For now, just show an alert that this feature is coming soon
      alert('Delete functionality for non-player entries is coming soon.');
      // TODO: Implement API endpoint for deleting non-player entries
      // const response = await fetch(`/api/admin/non-player-entries/${entryId}`, {
      //   method: 'DELETE'
      // });
      // 
      // if (!response.ok) {
      //   throw new Error('Failed to delete entry');
      // }
      // 
      // const row = document.querySelector(`tr[data-entry-id="${entryId}"]`);
      // if (row) {
      //   row.remove();
      //   updateEntryCount();
      //   const nonPlayersCount = document.querySelectorAll('#non-player-entries-tbody tr').length;
      //   const nonPlayersCountEl = document.getElementById('non-players-count');
      //   if (nonPlayersCountEl) nonPlayersCountEl.textContent = String(nonPlayersCount);
      // }
    } catch (error) {
      console.error('Error deleting non-player entry:', error);
      alert('Failed to delete entry. Please try again.');
    }
  }

  // Logout handler
  async function handleLogout(): Promise<void> {
    try {
      const response = await fetch('/api/logout', {
        method: 'POST'
      });
      
      if (response.ok) {
        window.location.href = '/login';
      } else {
        console.error('Logout failed');
      }
    } catch (error) {
      console.error('Logout error:', error);
    }
  }

  // Initialize event listeners
  document.addEventListener('DOMContentLoaded', () => {
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.getAttribute('data-tab');
        if (tabName) {
          switchTab(tabName);
        }
      });
    });

    // Set initial active tab
    switchTab('players');

    // Search input
    const searchInput = document.getElementById('search-input');
    searchInput?.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value;
      filterEntries(query);
    });

    // Sort button
    const sortBtn = document.getElementById('sort-btn');
    const sortDropdown = document.getElementById('sort-dropdown');
    
    sortBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      sortDropdown?.classList.toggle('hidden');
    });
    
    document.addEventListener('click', () => {
      sortDropdown?.classList.add('hidden');
    });
    
    sortDropdown?.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    // Sort options
    document.querySelectorAll('.sort-option').forEach(option => {
      option.addEventListener('click', () => {
        const sortType = option.getAttribute('data-sort');
        if (sortType) {
          sortEntries(sortType);
          sortDropdown?.classList.add('hidden');
        }
      });
    });

    // Export CSVs button
    document.getElementById('export-csv-btn')?.addEventListener('click', exportCSV);

    // Logout button
    document.getElementById('logout-btn')?.addEventListener('click', handleLogout);

    // Check-in checkboxes
    document.querySelectorAll('.check-in-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        const entryId = target.getAttribute('data-entry-id');
        if (entryId) {
          updateCheckIn(entryId, target.checked);
        }
      });
    });

    // Delete buttons
    document.querySelectorAll('.delete-entry-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const entryId = btn.getAttribute('data-entry-id');
        const entryName = btn.getAttribute('data-entry-name');
        if (entryId && entryName) {
          deleteEntry(entryId, entryName);
        }
      });
    });

    // Delete non-player entry buttons
    document.querySelectorAll('.delete-non-player-entry-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const entryId = btn.getAttribute('data-entry-id');
        const entryName = btn.getAttribute('data-entry-name');
        if (entryId && entryName) {
          deleteNonPlayerEntry(entryId, entryName);
        }
      });
    });
  });
</script>
