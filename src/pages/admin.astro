---
import Layout from '../layouts/Layout.astro';
import { isAuthenticated } from '../lib/auth';
import { getAllSubmissions, getAllNonPlayerSubmissions, initializeDatabase } from '../lib/database';

// Check authentication
if (!isAuthenticated(Astro.cookies)) {
  return Astro.redirect('/login', 302);
}

// Initialize database schema (ensures migrations run)
await initializeDatabase();

// Fetch entries server-side
const entries = await getAllSubmissions();
const nonPlayerEntries = await getAllNonPlayerSubmissions();

// Helper function to split name
function splitName(name: string): { firstName: string; lastName: string } {
  const parts = name.trim().split(/\s+/);
  return {
    firstName: parts[0] || '',
    lastName: parts.slice(1).join(' ') || ''
  };
}

// Background image - update this path to your actual background image
const imgBackground = '/assets/background.jpg'; // Update with your actual image path
---

<Layout title="Admin Dashboard">
  <div class="relative min-h-screen py-4 px-2 bg-black">

    <div 
      aria-hidden="true" 
      class="fixed-bg-mobile inset-0 pointer-events-none bg-no-repeat bg-center bg-cover"
      style={`background-image: url('${imgBackground}');`}
    ></div>

    <div 
      aria-hidden="true" 
      class="fixed inset-0 pointer-events-none bg-gradient-to-b from-transparent to-black/60 z-0"
    ></div>

    <!-- Header -->
    <div class="relative z-10 flex justify-between items-center mb-4 pb-4 border-b border-gray-200 max-w-7xl mx-auto">
        <div class="flex flex-row gap-4">
            <a href="/" class="h-[60px] overflow-clip relative shrink-0 w-[95px] ml-3">
              <!-- <svg id="Layer_2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 375.06 152.68" class="block max-w-none size-full">
                <defs>
                  <style>.cls-1{fill-rule:evenodd;}.cls-1,.cls-2{fill:#fff;}</style>
                </defs>
                <g id="Layer_2-2">
                  <g id="Artwork_201">
                    <path class="cls-2" d="M49.2,47.9c-5.1-3.6-11.3-5.7-18-5.7C13.9,42.2,0,56.2,0,73.5s14,31.2,31.2,31.2,12.9-2.1,17.9-5.7v.2l14.6,4.2v-59.8l-14.6,4.2.1.1ZM31.7,90.8c-9.6,0-17.3-7.8-17.3-17.3s7.8-17.3,17.3-17.3,17.3,7.8,17.3,17.3-7.8,17.3-17.3,17.3M306.4,47.9c-5.1-3.6-11.3-5.7-18-5.7-17.3,0-31.3,14-31.3,31.3s14,31.2,31.3,31.2,12.9-2.1,17.9-5.7v.2l14.6,4.2v-59.8l-14.6,4.2.1.1ZM288.9,90.8c-9.6,0-17.3-7.8-17.3-17.3s7.8-17.3,17.3-17.3,17.3,7.8,17.3,17.3-7.8,17.3-17.3,17.3M125.7,73.5v.6-1.2.6M125.7,73.5v.6-1.2.6M125.7,73.5v.6-1.2.6M125.7,0v47.8c-5-3.5-11.2-5.5-17.8-5.5-17.3,0-31.3,14-31.3,31.3s14,31.2,31.3,31.2,12.7-2,17.8-5.5h0l14.8,4.3V.1h-14.8v-.1ZM125.7,74.1c-.3,9.3-7.9,16.7-17.3,16.7s-17.3-7.8-17.3-17.3,7.8-17.3,17.3-17.3,17,7.4,17.3,16.7v1.2M229.9,73.5v.9-1.8.9M229.9,73.5v.9-1.8.9M229.8,0v47.8c-5-3.5-11.2-5.5-17.8-5.5-17.3,0-31.3,14-31.3,31.3s14,31.2,31.3,31.2,12.7-2,17.8-5.5h0l14.8,4.3V.1h-14.8v-.1ZM229.8,74.4c-.5,9.1-8,16.4-17.3,16.4s-17.3-7.8-17.3-17.3,7.8-17.3,17.3-17.3,16.8,7.3,17.3,16.4v1.8M229.9,73.5v.9-1.8.9M153.4,43.7h14.8v59.8h-14.8v-59.8h0ZM168.3,28.5c0,4.1-3.3,7.4-7.4,7.4s-7.4-3.3-7.4-7.4,3.3-7.4,7.4-7.4,7.4,3.3,7.4,7.4M369.5,58.8c-7.4-4.7-14.5-5.7-17.4-2.7-1.2,1.2-2.1,3.3-1.6,5.2.7,2.7,4,3.7,7.9,5.4,5.6,2.5,12,5.5,14.9,10.6,3.8,6.7.3,14.9,0,15.4-2.2,4.8-5.8,7.3-7,8.1-12.4,8.4-31.2-1.1-32.2-1.6l4.1-12c1,.6,12.2,7.3,18.6,4.9.9-.4,2.8-1.1,3.8-2.9,1.1-2.1.4-4.5.2-4.8-1.2-3.5-5-3.7-11.3-7-4.9-2.6-9.6-5.1-12-10-2-4.4-1.3-8.6-1-9.9,1.3-6.5,6-10.1,7.5-11.2,6.5-4.7,13.8-4,16.9-3.7,6,.6,10.4,2.9,12.8,4.4l-4.2,11.9v-.1Z"/>
                    <path class="cls-1" d="M287,140.8c0-2.5,0-5.1-.2-7.6-.1-3.2-2.8-5.8-6-5.7-2.3-.1-7.2,0-7.4,0v25c.2,0,5.1.1,7.4,0,3.2,0,5.9-2.5,6-5.7.2-2,.2-4,.2-6M282.9,145.4c0,1.9-1.5,3.5-3.4,3.6h-2.2v-18c1,0,2.1.1,3.1.3,1.5.3,2.5,1.7,2.4,3.2v10.9h.1Z"/>
                    <path class="cls-1" d="M266.2,131c-1.1-2.7-3.5-3.6-6.4-3.5-3.7,0-6.4,2.3-6.5,5.9-.2,4.4-.1,8.8,0,13.2.1,3.4,2.2,5.5,5.6,6,4.4.5,7.6-1.5,8-5.9.2-2.1.1-9.8,0-11.5,0-1.4-.2-2.8-.7-4.1M262.9,146.3c0,1.5-1.2,2.7-2.7,2.7h-.3c-1.5,0-2.8-1.1-2.8-2.6v-12.5c0-1.6,1.1-2.9,2.7-3h.9c1.3.2,2.3,1.3,2.2,2.6v12.7h0v.1Z"/>
                    <path class="cls-1" d="M192.3,129.5c-1.5-1.5-3.6-2.3-5.8-2-3.2,0-5.9,2.6-6,5.9-.1,4.4,0,8.9,0,13.3,0,1.6.7,3.2,1.9,4.3,1.4,1.2,3.2,1.8,5,1.6,3.3.2,6.2-2.3,6.4-5.6v-.2c.1-2.2.2-10.2.2-12,0-1.9-.5-3.8-1.7-5.3M190.1,146.2c0,1.5-1.1,2.8-2.6,2.9-.3,0-.6,0-.9-.1-1.3-.2-2.3-1.4-2.2-2.7v-12.5c0-1.5,1.1-2.7,2.6-2.8h.3c1.5,0,2.7,1.1,2.8,2.5v12.6h0v.1Z"/>
                    <path class="cls-1" d="M200.6,127.5v25c0,.2,0,0,0,0h3.9v-10.1h5.6v-3.9h-5.6v-7.7h7.6v-3.5h-11.6l.1.2Z"/>
                    <path class="cls-1" d="M246.6,138.9h-7v3.2h3.3c.1,1,0,5.7,0,6.7-1.2.8-2.7,1.1-4,.7-2-.6-2-2.4-2.1-4.5-.1-2.5-.2-3.9-.2-6.4v-4.6c0-1.3.9-2.5,2.3-2.7,1.5-.3,2.9.6,3.2,2.1v.3c.2.8.2,1.7.3,2.5h4.1c0-.9-.2-1.8-.4-2.6-.3-2.4-1.3-4.4-3.6-5.4-2.5-1.2-5.5-.8-7.7.9-.6.5-1,1-1.3,1.7-.5,1.3-.9,2.6-.9,4-.1,3-.1,6,0,9.1,0,1.4.2,2.8.5,4.1.5,2.5,2.7,4.4,5.3,4.5,6,.7,8.1-2.5,8.1-2.5v-11.1h.1Z"/>
                    <path class="cls-1" d="M129.1,127.5c-1.3,7.1-2.8,14.8-4.2,21.9-.2,1.1-.4,2.1-.6,3.2h3.8c.3-1.8.7-3.6,1-5.4h5.4c.4,1.8.7,3.6,1.1,5.4h4.1c-1.7-8.4-3.4-16.7-5.1-25.1h-5.5M129.8,143.5l2-10.8h.1l2,10.8h-4.1Z"/>
                    <path class="cls-1" d="M106.3,152.6h11.4v-3.6h-7.5v-6.5h5.5v-3.9h-5.6v-7.7h7.5v-3.5h-11.4v25.1l.1.1Z"/>
                    <polygon class="cls-1" points="88.2 152.6 92.1 152.6 92.1 142.5 97.8 142.5 97.7 138.7 92.2 138.7 92.2 131 99.8 131 99.8 127.5 88.2 127.5 88.2 152.6"/>
                    <path class="cls-1" d="M156.2,141.2c2-.8,3.3-2.7,3.4-4.8.2-1.2.2-2.5,0-3.7-.3-3.2-2.6-5.2-6-5.2h-7.4v25.1h3.9v-10.2h2.3c1,3,2.4,7.2,3.4,10.2h4.2c-1.2-3.6-2.7-8.1-3.8-11.4h0ZM155.8,135.7c0,1.8-1.5,2.6-3.4,2.7h-2.2v-7.8c1,0,2.1,0,3.1.1,1.5.3,2.4.8,2.4,2.5v2.4h0l.1.1Z"/>
                  </g>
                </g>
              </svg> -->
            </a>
        </div>

        <div class="flex gap-2">
          <!-- Export CSVs Button -->
            <button
            id="export-csv-btn"
            class="px-3 py-2 border border-gray-200 rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors flex items-center gap-2.5 font-semibold uppercase text-sm shadow-sm"
            >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Export CSVs
            </button>
            <button
            id="logout-btn"
            class="px-3 py-2 border border-gray-200 rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors flex items-center gap-2.5 font-semibold uppercase text-sm shadow-sm"
            >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            Logout
            </button>
        </div>
    </div>

    <div class="relative z-10 max-w-7xl mx-auto bg-white/90 rounded-xl shadow-md p-2">
      <!-- Search and Filter Section -->
      <div class="flex flex-col sm:flex-row gap-2 mb-3 sm:items-center">
        <div class="flex-1 relative w-full">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          <input
            type="text"
            id="search-input"
            placeholder="SEARCH ENTRIES"
            class="w-full pl-12 pr-5 py-3.5 border border-gray-200 rounded-lg bg-gray-50/50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:border-transparent font-semibold uppercase text-sm"
          />
        </div>
        <div class="relative w-full sm:w-auto">
          <button
            id="sort-btn"
            class="w-full sm:w-auto px-3 py-3.5 border border-gray-200 rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors flex items-center gap-2 font-semibold uppercase text-sm shadow-sm sm:min-w-[140px] justify-between"
            aria-expanded="false"
            aria-haspopup="true"
          >
            <span class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
              </svg>
              <span id="sort-label">Name (A-Z)</span>
            </span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div
            id="sort-dropdown"
            class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50"
          >
            <button
              class="sort-option w-full text-left px-4 py-3 text-sm font-semibold uppercase text-gray-700 hover:bg-gray-50 transition-colors flex items-center justify-between"
              data-sort="name-asc"
            >
              <span>Name (A-Z)</span>
              <svg class="w-4 h-4 hidden check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </button>
            <button
              class="sort-option w-full text-left px-4 py-3 text-sm font-semibold uppercase text-gray-700 hover:bg-gray-50 transition-colors flex items-center justify-between border-t border-gray-100"
              data-sort="name-desc"
            >
              <span>Name (Z-A)</span>
              <svg class="w-4 h-4 hidden check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </button>
            <button
              class="sort-option w-full text-left px-4 py-3 text-sm font-semibold uppercase text-gray-700 hover:bg-gray-50 transition-colors flex items-center justify-between border-t border-gray-100"
              data-sort="date"
            >
              <span>Date</span>
              <svg class="w-4 h-4 hidden check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </button>
          </div>
        </div>
        <p class="text-sm font-semibold text-gray-500 uppercase tracking-wide text-center sm:text-left pr-3">
            Total <span id="entry-count" class="font-bold text-gray-700">{entries.length + nonPlayerEntries.length}</span> Entries
        </p>
      </div>

      <!-- Title and Tabs Section -->
      <div class="mb-4 border-b border-gray-200 pb-2">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pl-3 md:pt-6 md:pb-0">
          <h2 id="section-title" class="text-2xl font-bold text-gray-800 uppercase tracking-tight text-center sm:text-left">Player Entries</h2>
          <div class="inline-flex bg-gray-100 rounded-lg p-1 shadow-inner" style="box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.25);">
            <button
              id="tab-players"
              class="tab-btn px-6 py-2.5 text-sm font-semibold uppercase tracking-wide rounded-md bg-gray-600 text-white transition-all duration-100 shadow-sm"
              data-tab="players"
            >
              Players (<span id="players-count">{entries.length}</span>)
            </button>
            <button
              id="tab-non-players"
              class="tab-btn px-6 py-2.5 text-sm font-semibold uppercase tracking-wide rounded-md bg-transparent text-gray-600 transition-all duration-100"
              data-tab="non-players"
            >
              Non-Players (<span id="non-players-count">{nonPlayerEntries.length}</span>)
            </button>
          </div>
        </div>
      </div>

      <!-- Players Table Section -->
      <div id="players-table-section" class="tab-content">

        <div class="overflow-x-auto rounded-xl shadow-md border bg-white border-gray-200">
          {entries.length === 0 ? (
            <div class="text-center py-16 text-gray-500">
              <p class="text-lg font-semibold mb-2">No player entries found.</p>
              <p class="text-sm">Entries will appear here once users submit the RSVP form.</p>
            </div>
          ) : (
            <table class="w-full border-collapse min-w-full">
              <thead>
                <tr class="bg-[#F1F3F5]">
                  <th class="w-auto px-2 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300">Check-In</th>
                  <th class="px-2 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200">Name</th>
                  <th class="px-2 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200">Email</th>
                  <th class="px-2 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200">Phone</th>
                  <th class="px-2 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200">Alt. Contact Name</th>
                  <th class="px-2 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200">Alt. Contact Phone</th>
                  <th class="px-2 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200">Alt. Contact Email</th>
                  <th class="px-2 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200">Address</th>
                  <th class="px-2 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200">Sizes</th>
                  <th class="px-2 py-2 text-center text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200">Actions</th>
                </tr>
              </thead>
              <tbody id="entries-tbody" class="divide-y divide-gray-200">
                {entries.map((entry) => {
                const checkInStatus = entry.checked_in ? 'ATTENDING' : 'CHECK-IN';
                const checkInColor = entry.checked_in 
                  ? 'bg-green-100 text-green-800 border border-green-200' 
                  : 'bg-yellow-100 text-yellow-800 border border-yellow-200';
                const { firstName } = splitName(entry.name || '');
                const dateValue = typeof entry.created_at === 'string' 
                  ? new Date(entry.created_at).toISOString()
                  : (entry.created_at as Date).toISOString();
                const sizes = [
                  entry.top_size ? `Top: ${entry.top_size}` : null,
                  entry.bottom_size ? `Bottom: ${entry.bottom_size}` : null,
                  entry.jacket_size ? `Jacket: ${entry.jacket_size}` : null,
                  entry.tight_size ? `Tight: ${entry.tight_size}` : null,
                  entry.shoe_size ? `Shoe: ${entry.shoe_size}` : null
                ].filter(Boolean).join(', ') || '—';
                
                return (
                  <tr 
                    class="hover:bg-gray-50/50 transition-colors" 
                    data-entry-id={entry.id}
                    data-first-name={firstName.toLowerCase()}
                    data-created-at={dateValue}
                  >
                    <td class="w-auto px-2 py-2 whitespace-nowrap">
                      <label class="cursor-pointer inline-flex items-center justify-center">
                        <input
                          type="checkbox"
                          class="sr-only check-in-checkbox"
                          data-entry-id={entry.id}
                          checked={entry.checked_in || false}
                        />
                        <span class={`inline-flex items-center justify-center w-8 h-8 rounded-full text-xs font-bold uppercase tracking-wide ${checkInColor}`}>
                          {entry.checked_in ? (
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
                            </svg>
                          ) : (
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <circle cx="12" cy="12" r="9" stroke-width="2" />
                            </svg>
                          )}
                        </span>
                      </label>
                    </td>
                    <td class="px-2 py-2 text-md font-semibold text-gray-800 capitalize border-l border-gray-100 whitespace-nowrap">{entry.name || '—'}</td>
                    <td class="px-2 py-2 text-md font-semibold text-gray-800 border-l border-gray-100 whitespace-nowrap">{entry.email}</td>
                    <td class="px-2 py-2 text-md font-semibold text-gray-800 border-l border-gray-100 whitespace-nowrap">{entry.phone || '—'}</td>
                    <td class="px-2 py-2 text-md font-semibold text-gray-800 border-l border-gray-100 whitespace-nowrap">{entry.alternative_contact_name || '—'}</td>
                    <td class="px-2 py-2 text-md font-semibold text-gray-800 border-l border-gray-100 whitespace-nowrap">{entry.alternative_contact_phone || '—'}</td>
                    <td class="px-2 py-2 text-md font-semibold text-gray-800 border-l border-gray-100 whitespace-nowrap">{entry.alternative_contact_email || '—'}</td>
                    <td class="px-2 py-2 text-md font-semibold text-gray-800 border-l border-gray-100 whitespace-nowrap">{entry.address || '—'}</td>
                    <td class="px-2 py-2 text-md font-semibold text-gray-800 border-l border-gray-100 whitespace-nowrap">{sizes}</td>
                    <td class="px-2 py-2 text-center border-l border-gray-100 whitespace-nowrap">
                      <button
                        class="delete-entry-btn px-3 py-1.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-semibold uppercase flex items-center gap-2 mx-auto"
                        data-entry-id={entry.id}
                        data-entry-name={entry.name}
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    </td>
                  </tr>
                );
                })}
              </tbody>
            </table>
          )}
        </div>
      </div>

      <!-- Non-Players Table Section -->
      <div id="non-players-table-section" class="tab-content hidden">

        <div class="overflow-x-auto rounded-xl shadow-md border bg-white border-gray-200">
          {nonPlayerEntries.length === 0 ? (
            <div class="text-center py-16 text-gray-500">
              <p class="text-lg font-semibold mb-2">No non-player entries found.</p>
              <p class="text-sm">Entries will appear here once users submit the non-player form.</p>
            </div>
          ) : (
            <table class="w-full border-collapse min-w-full">
              <thead>
                <tr class="bg-[#F1F3F5]">
                  <th class="px-2 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300">Name</th>
                  <th class="px-2 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200">Email</th>
                  <th class="px-2 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200">Phone</th>
                  <th class="px-2 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200">Ticket Count</th>
                  <th class="px-2 py-2 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200">Additional Tickets</th>
                  <th class="px-2 py-2 text-center text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200">Actions</th>
                </tr>
              </thead>
              <tbody id="non-player-entries-tbody" class="divide-y divide-gray-200">
                {nonPlayerEntries.map((entry) => {
                const { firstName } = splitName(entry.name || '');
                const dateValue = typeof entry.created_at === 'string' 
                  ? new Date(entry.created_at).toISOString()
                  : (entry.created_at as Date).toISOString();
                const additionalTickets = entry.additional_tickets && entry.additional_tickets.length > 0
                  ? entry.additional_tickets.map(ticket => 
                      typeof ticket === 'string' 
                        ? ticket 
                        : `${ticket.name} (${ticket.email}, ${ticket.phone})`
                    ).join(', ')
                  : '—';
                
                return (
                  <tr 
                    class="hover:bg-gray-50/50 transition-colors" 
                    data-entry-id={entry.id}
                    data-first-name={firstName.toLowerCase()}
                    data-created-at={dateValue}
                  >
                    <td class="px-2 py-2 text-md font-semibold text-gray-800 capitalize whitespace-nowrap">{entry.name || '—'}</td>
                    <td class="px-2 py-2 text-md font-semibold text-gray-800 border-l border-gray-100 whitespace-nowrap">{entry.email}</td>
                    <td class="px-2 py-2 text-md font-semibold text-gray-800 border-l border-gray-100 whitespace-nowrap">{entry.phone || '—'}</td>
                    <td class="px-2 py-2 text-md font-semibold text-gray-800 border-l border-gray-100 whitespace-nowrap">{entry.ticket_count}</td>
                    <td class="px-2 py-2 text-md font-semibold text-gray-800 border-l border-gray-100 whitespace-nowrap">{additionalTickets}</td>
                    <td class="px-2 py-2 text-center border-l border-gray-100 whitespace-nowrap">
                      <button
                        class="delete-non-player-entry-btn px-3 py-1.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-semibold uppercase flex items-center gap-2 mx-auto"
                        data-entry-id={entry.id}
                        data-entry-name={entry.name}
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    </td>
                  </tr>
                );
                })}
              </tbody>
            </table>
          )}
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Helper function to split name
  function splitName(name: string): { firstName: string; lastName: string } {
    const parts = name.trim().split(/\s+/);
    return {
      firstName: parts[0] || '',
      lastName: parts.slice(1).join(' ') || ''
    };
  }

  // Get current active tab
  function getActiveTab(): string {
    const activeTab = document.querySelector('.tab-btn.bg-gray-600');
    return activeTab?.getAttribute('data-tab') || 'players';
  }

  // Get all entries from the active table
  function getAllEntries(): HTMLElement[] {
    const activeTab = getActiveTab();
    const tbodyId = activeTab === 'players' ? 'entries-tbody' : 'non-player-entries-tbody';
    return Array.from(document.querySelectorAll(`#${tbodyId} tr`));
  }

  // Filter entries based on search query - filters both tables
  function filterEntries(query: string): void {
    const lowerQuery = query.toLowerCase().trim();
    
    // Filter player entries
    const playersTbody = document.getElementById('entries-tbody');
    if (playersTbody) {
      const playerEntries = Array.from(playersTbody.querySelectorAll('tr'));
      
      if (lowerQuery.length < 2) {
        playerEntries.forEach(entry => {
          (entry as HTMLElement).style.display = '';
        });
      } else {
        playerEntries.forEach(entry => {
          const firstName = entry.getAttribute('data-first-name') || '';
          const name = entry.querySelector('td:nth-child(2)')?.textContent?.toLowerCase() || '';
          const email = entry.querySelector('td:nth-child(3)')?.textContent?.toLowerCase() || '';
          const phone = entry.querySelector('td:nth-child(4)')?.textContent?.toLowerCase() || '';
          const alternativeContact = entry.querySelector('td:nth-child(5)')?.textContent?.toLowerCase() || '';
          const address = entry.querySelector('td:nth-child(6)')?.textContent?.toLowerCase() || '';
          
          const matches = firstName.includes(lowerQuery) || 
            name.includes(lowerQuery) || 
            email.includes(lowerQuery) ||
            phone.includes(lowerQuery) ||
            alternativeContact.includes(lowerQuery) ||
            address.includes(lowerQuery);
          
          (entry as HTMLElement).style.display = matches ? '' : 'none';
        });
      }
    }
    
    // Filter non-player entries
    const nonPlayersTbody = document.getElementById('non-player-entries-tbody');
    if (nonPlayersTbody) {
      const nonPlayerEntries = Array.from(nonPlayersTbody.querySelectorAll('tr'));
      
      if (lowerQuery.length < 2) {
        nonPlayerEntries.forEach(entry => {
          (entry as HTMLElement).style.display = '';
        });
      } else {
        nonPlayerEntries.forEach(entry => {
          const firstName = entry.getAttribute('data-first-name') || '';
          const name = entry.querySelector('td:nth-child(1)')?.textContent?.toLowerCase() || '';
          const email = entry.querySelector('td:nth-child(2)')?.textContent?.toLowerCase() || '';
          const phone = entry.querySelector('td:nth-child(3)')?.textContent?.toLowerCase() || '';
          const additionalTickets = entry.querySelector('td:nth-child(5)')?.textContent?.toLowerCase() || '';
          
          const matches = firstName.includes(lowerQuery) || 
            name.includes(lowerQuery) || 
            email.includes(lowerQuery) ||
            phone.includes(lowerQuery) ||
            additionalTickets.includes(lowerQuery);
          
          (entry as HTMLElement).style.display = matches ? '' : 'none';
        });
      }
    }
    
    updateEntryCount();
  }

  // Update entry count display - shows total of visible entries from both tables
  function updateEntryCount(): void {
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const searchQuery = searchInput?.value?.trim() || '';
    
    // Count visible entries from both tables
    const playersTbody = document.getElementById('entries-tbody');
    const nonPlayersTbody = document.getElementById('non-player-entries-tbody');
    
    let totalCount = 0;
    
    // Count visible player entries
    if (playersTbody) {
      const playerRows = Array.from(playersTbody.querySelectorAll('tr'));
      const visiblePlayers = playerRows.filter(row => {
        const style = (row as HTMLElement).style.display;
        return style !== 'none';
      });
      totalCount += visiblePlayers.length;
    }
    
    // Count visible non-player entries
    if (nonPlayersTbody) {
      const nonPlayerRows = Array.from(nonPlayersTbody.querySelectorAll('tr'));
      const visibleNonPlayers = nonPlayerRows.filter(row => {
        const style = (row as HTMLElement).style.display;
        return style !== 'none';
      });
      totalCount += visibleNonPlayers.length;
    }
    
    const countEl = document.getElementById('entry-count');
    if (countEl) {
      countEl.textContent = String(totalCount);
    }
  }

  // Sort entries
  let currentSort: string = 'name-asc';
  
  function sortEntries(sortType: string): void {
    currentSort = sortType;
    const activeTab = getActiveTab();
    const tbodyId = activeTab === 'players' ? 'entries-tbody' : 'non-player-entries-tbody';
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;
    
    const entries = Array.from(tbody.querySelectorAll('tr'));
    // For players: name is 2nd column (after check-in), for non-players: name is 1st column
    const nameCol = activeTab === 'players' ? 2 : 1;
    
    entries.sort((a, b) => {
      if (sortType === 'name-asc') {
        const nameA = (a.querySelector(`td:nth-child(${nameCol})`)?.textContent || '').toLowerCase();
        const nameB = (b.querySelector(`td:nth-child(${nameCol})`)?.textContent || '').toLowerCase();
        return nameA.localeCompare(nameB);
      } else if (sortType === 'name-desc') {
        const nameA = (a.querySelector(`td:nth-child(${nameCol})`)?.textContent || '').toLowerCase();
        const nameB = (b.querySelector(`td:nth-child(${nameCol})`)?.textContent || '').toLowerCase();
        return nameB.localeCompare(nameA);
      } else if (sortType === 'date') {
        const dateA = new Date(a.getAttribute('data-created-at') || '').getTime();
        const dateB = new Date(b.getAttribute('data-created-at') || '').getTime();
        return dateB - dateA;
      }
      return 0;
    });
    
    entries.forEach(entry => tbody.appendChild(entry));
    
    // Update sort label
    const sortLabel = document.getElementById('sort-label');
    if (sortLabel) {
      if (sortType === 'name-asc') sortLabel.textContent = 'Name (A-Z)';
      else if (sortType === 'name-desc') sortLabel.textContent = 'Name (Z-A)';
      else if (sortType === 'date') sortLabel.textContent = 'Date';
    }
    
    // Update check icons
    document.querySelectorAll('.sort-option').forEach(option => {
      const icon = option.querySelector('.check-icon');
      if (option.getAttribute('data-sort') === sortType) {
        icon?.classList.remove('hidden');
      } else {
        icon?.classList.add('hidden');
      }
    });
  }

  // Switch tabs
  function switchTab(tabName: string): void {
    // Update tab buttons - switch style
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('bg-gray-600', 'text-white', 'shadow-sm');
      btn.classList.add('bg-transparent', 'text-gray-600');
    });
    
    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    if (activeBtn) {
      activeBtn.classList.remove('bg-transparent', 'text-gray-600');
      activeBtn.classList.add('bg-gray-600', 'text-white', 'shadow-sm');
    }
    
    // Update section title
    const sectionTitle = document.getElementById('section-title');
    if (sectionTitle) {
      sectionTitle.textContent = tabName === 'players' ? 'Player Entries' : 'Non-Player Entries';
    }
    
    // Show/hide table sections
    const playersSection = document.getElementById('players-table-section');
    const nonPlayersSection = document.getElementById('non-players-table-section');
    
    if (tabName === 'players') {
      playersSection?.classList.remove('hidden');
      nonPlayersSection?.classList.add('hidden');
    } else {
      playersSection?.classList.add('hidden');
      nonPlayersSection?.classList.remove('hidden');
    }
    
    // Re-apply current search filter (which will update entry count)
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    if (searchInput?.value) {
      filterEntries(searchInput.value);
    } else {
      updateEntryCount();
    }
  }

  // Export CSV - downloads both Players and Non-Players CSVs
  async function exportCSV(): Promise<void> {
    try {
      // Download Players CSV
      const playersResponse = await fetch('/api/admin/entries/export');
      if (!playersResponse.ok) {
        throw new Error('Failed to export players CSV');
      }
      const playersBlob = await playersResponse.blob();
      const playersUrl = window.URL.createObjectURL(playersBlob);
      const playersLink = document.createElement('a');
      playersLink.href = playersUrl;
      playersLink.download = `players-entries-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(playersLink);
      playersLink.click();
      document.body.removeChild(playersLink);
      window.URL.revokeObjectURL(playersUrl);

      // Small delay to ensure first download starts
      await new Promise(resolve => setTimeout(resolve, 500));

      // Download Non-Players CSV
      const nonPlayersResponse = await fetch('/api/admin/entries/export-non-players');
      if (!nonPlayersResponse.ok) {
        throw new Error('Failed to export non-players CSV');
      }
      const nonPlayersBlob = await nonPlayersResponse.blob();
      const nonPlayersUrl = window.URL.createObjectURL(nonPlayersBlob);
      const nonPlayersLink = document.createElement('a');
      nonPlayersLink.href = nonPlayersUrl;
      nonPlayersLink.download = `non-players-entries-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(nonPlayersLink);
      nonPlayersLink.click();
      document.body.removeChild(nonPlayersLink);
      window.URL.revokeObjectURL(nonPlayersUrl);
    } catch (error) {
      console.error('Error exporting CSVs:', error);
      alert('Failed to export CSVs. Please try again.');
    }
  }

  // Update check-in status
  async function updateCheckIn(entryId: string, checkedIn: boolean): Promise<void> {
    try {
      const response = await fetch(`/api/admin/entries/${entryId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ checked_in: checkedIn })
      });
      
      if (!response.ok) {
        throw new Error('Failed to update check-in status');
      }
      
      // Update UI
      const row = document.querySelector(`tr[data-entry-id="${entryId}"]`);
      if (row) {
        const checkbox = row.querySelector('.check-in-checkbox') as HTMLInputElement;
        const statusSpan = row.querySelector('td:first-child span');
        
        if (checkbox) checkbox.checked = checkedIn;
        if (statusSpan) {
          statusSpan.className = checkedIn
            ? 'inline-flex items-center justify-center w-8 h-8 rounded-full text-xs font-bold uppercase tracking-wide bg-green-100 text-green-800 border border-green-200'
            : 'inline-flex items-center justify-center w-8 h-8 rounded-full text-xs font-bold uppercase tracking-wide bg-yellow-100 text-yellow-800 border border-yellow-200';
          statusSpan.innerHTML = checkedIn
            ? `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" /></svg>`
            : `<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke-width="2" /></svg>`;
        }
      }
    } catch (error) {
      console.error('Error updating check-in:', error);
      alert('Failed to update check-in status. Please try again.');
    }
  }

  // Delete entry
  async function deleteEntry(entryId: string, entryName: string): Promise<void> {
    if (!confirm(`Are you sure you want to delete the entry for ${entryName}?`)) {
      return;
    }
    
    try {
      const response = await fetch(`/api/admin/entries/${entryId}`, {
        method: 'DELETE'
      });
      
      if (!response.ok) {
        throw new Error('Failed to delete entry');
      }
      
      // Remove row from table
      const row = document.querySelector(`tr[data-entry-id="${entryId}"]`);
      if (row) {
        row.remove();
        // Update players count
        const playersCount = document.querySelectorAll('#entries-tbody tr').length;
        const playersCountEl = document.getElementById('players-count');
        if (playersCountEl) playersCountEl.textContent = String(playersCount);
        // Update total count (which includes both tables)
        updateEntryCount();
      }
    } catch (error) {
      console.error('Error deleting entry:', error);
      alert('Failed to delete entry. Please try again.');
    }
  }

  // Delete non-player entry
  async function deleteNonPlayerEntry(entryId: string, entryName: string): Promise<void> {
    if (!confirm(`Are you sure you want to delete the entry for ${entryName}?`)) {
      return;
    }
    
    try {
      // For now, we'll need to create an API endpoint for this
      // For now, just show an alert that this feature is coming soon
      alert('Delete functionality for non-player entries is coming soon.');
      // TODO: Implement API endpoint for deleting non-player entries
      // const response = await fetch(`/api/admin/non-player-entries/${entryId}`, {
      //   method: 'DELETE'
      // });
      // 
      // if (!response.ok) {
      //   throw new Error('Failed to delete entry');
      // }
      // 
      // const row = document.querySelector(`tr[data-entry-id="${entryId}"]`);
      // if (row) {
      //   row.remove();
      //   updateEntryCount();
      //   const nonPlayersCount = document.querySelectorAll('#non-player-entries-tbody tr').length;
      //   const nonPlayersCountEl = document.getElementById('non-players-count');
      //   if (nonPlayersCountEl) nonPlayersCountEl.textContent = String(nonPlayersCount);
      // }
    } catch (error) {
      console.error('Error deleting non-player entry:', error);
      alert('Failed to delete entry. Please try again.');
    }
  }

  // Logout handler
  async function handleLogout(): Promise<void> {
    try {
      const response = await fetch('/api/logout', {
        method: 'POST'
      });
      
      if (response.ok) {
        window.location.href = '/login';
      } else {
        console.error('Logout failed');
      }
    } catch (error) {
      console.error('Logout error:', error);
    }
  }

  // Initialize event listeners
  document.addEventListener('DOMContentLoaded', () => {
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.getAttribute('data-tab');
        if (tabName) {
          switchTab(tabName);
        }
      });
    });

    // Set initial active tab
    switchTab('players');

    // Search input
    const searchInput = document.getElementById('search-input');
    searchInput?.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value;
      filterEntries(query);
    });

    // Sort button
    const sortBtn = document.getElementById('sort-btn');
    const sortDropdown = document.getElementById('sort-dropdown');
    
    sortBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      sortDropdown?.classList.toggle('hidden');
    });
    
    document.addEventListener('click', () => {
      sortDropdown?.classList.add('hidden');
    });
    
    sortDropdown?.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    // Sort options
    document.querySelectorAll('.sort-option').forEach(option => {
      option.addEventListener('click', () => {
        const sortType = option.getAttribute('data-sort');
        if (sortType) {
          sortEntries(sortType);
          sortDropdown?.classList.add('hidden');
        }
      });
    });

    // Export CSVs button
    document.getElementById('export-csv-btn')?.addEventListener('click', exportCSV);

    // Logout button
    document.getElementById('logout-btn')?.addEventListener('click', handleLogout);

    // Check-in checkboxes
    document.querySelectorAll('.check-in-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        const entryId = target.getAttribute('data-entry-id');
        if (entryId) {
          updateCheckIn(entryId, target.checked);
        }
      });
    });

    // Delete buttons
    document.querySelectorAll('.delete-entry-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const entryId = btn.getAttribute('data-entry-id');
        const entryName = btn.getAttribute('data-entry-name');
        if (entryId && entryName) {
          deleteEntry(entryId, entryName);
        }
      });
    });

    // Delete non-player entry buttons
    document.querySelectorAll('.delete-non-player-entry-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const entryId = btn.getAttribute('data-entry-id');
        const entryName = btn.getAttribute('data-entry-name');
        if (entryId && entryName) {
          deleteNonPlayerEntry(entryId, entryName);
        }
      });
    });
  });
</script>
